<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
    <meta name="theme-color" content="#4f46e5" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <title>EchoScript AI - Audio Transcription</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        darkMode: 'class',
        theme: {
          extend: {
            fontFamily: {
              sans: ['Inter', 'sans-serif'],
            },
            animation: {
              'pulse-slow': 'pulse 3s ease-in-out infinite',
              'float': 'float 6s ease-in-out infinite',
            },
            keyframes: {
              float: {
                '0%, 100%': { transform: 'translateY(0)' },
                '50%': { transform: 'translateY(-10px)' },
              }
            }
          },
        },
      }
    </script>

    <!-- Styles -->
    <style>
      @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
      
      body {
        font-family: 'Inter', sans-serif;
        user-select: none;
        -webkit-user-select: none;
        -webkit-tap-highlight-color: transparent;
        overscroll-behavior-y: none;
      }

      /* Custom Scrollbar */
      ::-webkit-scrollbar {
        width: 6px;
        height: 6px;
      }
      ::-webkit-scrollbar-track {
        background: transparent;
      }
      ::-webkit-scrollbar-thumb {
        background: #cbd5e1;
        border-radius: 3px;
      }
      .dark ::-webkit-scrollbar-thumb {
        background: #475569;
      }

      /* Selection color */
      ::selection {
        background-color: rgba(79, 70, 229, 0.3);
        color: inherit;
      }

      /* Smooth transitions */
      * {
        transition: background-color 0.3s ease, border-color 0.3s ease;
      }
    </style>

    <!-- Import Map -->
    <script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@18.2.0",
    "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
    "lucide-react": "https://esm.sh/lucide-react@0.344.0",
    "@google/genai": "https://esm.sh/@google/genai@0.1.1"
  }
}
</script>
    
    <!-- Babel for in-browser JSX compilation -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- PWA Manifest -->
    <link rel="manifest" id="manifest-link">
    <script>
      // Create dynamic manifest for PWA
      document.addEventListener('DOMContentLoaded', function() {
        const manifest = {
          name: "EchoScript AI",
          short_name: "EchoScript",
          start_url: ".",
          display: "standalone",
          background_color: "#ffffff",
          theme_color: "#4f46e5",
          orientation: "portrait",
          icons: [
            {
              src: "data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' rx='20' fill='%234f46e5'/><path d='M50 30C40 30 35 40 35 50V70C35 80 40 90 50 90C60 90 65 80 65 70V50C65 40 60 30 50 30Z' fill='white'/><path d='M80 50V70' stroke='white' stroke-width='6' stroke-linecap='round'/><path d='M20 50V70' stroke='white' stroke-width='6' stroke-linecap='round'/></svg>",
              sizes: "512x512",
              type: "image/svg+xml",
              purpose: "any maskable"
            }
          ]
        };
        
        const manifestBlob = new Blob([JSON.stringify(manifest)], { type: 'application/manifest+json' });
        const manifestUrl = URL.createObjectURL(manifestBlob);
        document.getElementById('manifest-link').href = manifestUrl;
      });

      // PWA install prompt
      let deferredPrompt;
      window.addEventListener('beforeinstallprompt', (e) => {
        e.preventDefault();
        deferredPrompt = e;
        // Show install button after 3 seconds
        setTimeout(showInstallButton, 3000);
      });

      function showInstallButton() {
        if (!deferredPrompt) return;
        
        const installBtn = document.createElement('button');
        installBtn.innerHTML = 'ðŸ“± Install EchoScript';
        installBtn.className = 'fixed bottom-4 right-4 z-50 bg-indigo-600 text-white px-4 py-2 rounded-full shadow-lg hover:bg-indigo-700 transition-colors text-sm font-medium';
        installBtn.onclick = () => {
          deferredPrompt.prompt();
          deferredPrompt.userChoice.then((choiceResult) => {
            if (choiceResult.outcome === 'accepted') {
              console.log('User accepted the install prompt');
              installBtn.remove();
            }
            deferredPrompt = null;
          });
        };
        document.body.appendChild(installBtn);
        
        // Auto remove after 15 seconds
        setTimeout(() => {
          if (installBtn.parentNode) {
            installBtn.remove();
          }
        }, 15000);
      }
    </script>
  </head>
  <body class="bg-slate-50 text-slate-900 antialiased dark:bg-slate-950 dark:text-slate-100">
    <div id="root"></div>

    <!-- Main Application Script -->
    <script type="text/babel" data-type="module" data-presets="env,react">
      import React, { useState, useEffect, useRef, useCallback } from 'react';
      import ReactDOM from 'react-dom/client';
      import { Mic, Upload, Sparkles, AlertTriangle, Moon, Sun, Square, AlertCircle, UploadCloud, FileAudio, X, User, Clock, Globe, Languages, Smile, Frown, Meh, Share2, Settings, Key, Download } from 'lucide-react';
      import { GoogleGenAI, Type } from '@google/genai';

      // Emotion types
      const Emotion = {
        Happy: 'Happy',
        Sad: 'Sad',
        Angry: 'Angry',
        Neutral: 'Neutral'
      };

      // --- API KEY MANAGEMENT ---
      const getApiKey = () => {
        return localStorage.getItem('ECHOSCRIPT_API_KEY') || '';
      };

      const setApiKey = (key) => {
        localStorage.setItem('ECHOSCRIPT_API_KEY', key);
      };

      // --- TRANSCRIPTION SERVICE ---
      const parseJson = (text) => {
        try {
          // Remove code blocks if present
          const cleanText = text.replace(/```json\n|\n```/g, "").replace(/```/g, "").trim();
          return JSON.parse(cleanText);
        } catch (e) {
          console.error("Failed to parse JSON response:", e);
          console.log("Raw text:", text);
          return { summary: "Error parsing transcription", segments: [] };
        }
      };

      const transcribeAudio = async (base64Audio, mimeType) => {
        const apiKey = getApiKey();
        if (!apiKey) {
          throw new Error("API Key is missing. Please set your Gemini API key in settings.");
        }

        const ai = new GoogleGenAI({ apiKey });
        const modelId = "gemini-1.5-flash";

        const prompt = `
          You are an expert audio transcription assistant.
          Process the provided audio file and generate a detailed transcription.
          
          Requirements:
          1. Identify distinct speakers (e.g., Speaker 1, Speaker 2).
          2. Provide accurate timestamps for each segment (Format: MM:SS).
          3. Detect the primary language of each segment.
          4. If the segment is in a language different than English, also provide the English translation.
          5. Identify the primary emotion of the speaker in this segment. You MUST choose exactly one of the following: Happy, Sad, Angry, Neutral.
          6. Provide a brief summary of the entire audio at the beginning.
          
          Output Format: JSON object with the following structure:
          {
            "summary": "A brief summary of the conversation...",
            "segments": [
              {
                "speaker": "Speaker 1",
                "timestamp": "00:00 - 00:15",
                "content": "Hello, how are you doing today?",
                "language": "English",
                "language_code": "en",
                "translation": "",
                "emotion": "Happy"
              },
              ...
            ]
          }
        `;

        try {
          const response = await ai.models.generateContent({
            model: modelId,
            contents: {
              parts: [
                {
                  inlineData: {
                    mimeType: mimeType,
                    data: base64Audio,
                  },
                },
                {
                  text: prompt,
                },
              ],
            },
            config: {
              temperature: 0.1,
              maxOutputTokens: 4000,
            },
          });

          const text = response.text;
          if (!text) throw new Error("No response text received from Gemini.");

          return parseJson(text);

        } catch (error) {
          console.error("Gemini Transcription Error:", error);
          
          // User-friendly error messages
          if (error.message.includes('API Key') || error.message.includes('API_KEY')) {
            throw new Error("Invalid API Key. Please check your Gemini API key in settings.");
          } else if (error.message.includes('quota')) {
            throw new Error("API quota exceeded. Please check your Gemini API usage limits.");
          } else if (error.message.includes('network')) {
            throw new Error("Network error. Please check your connection and try again.");
          } else {
            throw new Error("Transcription failed: " + error.message);
          }
        }
      };

      // --- REACT COMPONENTS ---

      // Button Component
      const Button = ({ 
        children, 
        variant = 'primary', 
        isLoading, 
        icon,
        className = '', 
        disabled,
        ...props 
      }) => {
        const baseStyles = "flex items-center justify-center px-4 py-2.5 rounded-lg font-medium transition-all focus:outline-none focus:ring-2 focus:ring-offset-2 disabled:opacity-50 disabled:cursor-not-allowed";
        
        const variants = {
          primary: "bg-indigo-600 text-white hover:bg-indigo-700 dark:bg-indigo-500 dark:hover:bg-indigo-600 focus:ring-indigo-500 shadow-md hover:shadow-lg",
          secondary: "bg-white dark:bg-slate-800 text-slate-700 dark:text-slate-200 border border-slate-200 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-700 focus:ring-slate-300 dark:focus:ring-slate-600 shadow-sm",
          danger: "bg-red-500 text-white hover:bg-red-600 dark:hover:bg-red-400 focus:ring-red-500 shadow-md",
          ghost: "bg-transparent text-slate-600 dark:text-slate-400 hover:bg-slate-100 dark:hover:bg-slate-800 hover:text-slate-900 dark:hover:text-white"
        };

        return (
          <button
            className={`${baseStyles} ${variants[variant]} ${className}`}
            disabled={isLoading || disabled}
            {...props}
          >
            {isLoading ? (
              <svg className="animate-spin -ml-1 mr-2 h-4 w-4 text-current" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
              </svg>
            ) : icon ? (
              <span className="mr-2">{icon}</span>
            ) : null}
            {children}
          </button>
        );
      };

      // API Key Input Component
      const ApiKeyModal = ({ isOpen, onClose, onSave }) => {
        const [apiKey, setApiKey] = useState(getApiKey());
        const [showKey, setShowKey] = useState(false);

        if (!isOpen) return null;

        const handleSave = () => {
          setApiKey(apiKey);
          onSave(apiKey);
          onClose();
        };

        return (
          <div className="fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-4">
            <div className="bg-white dark:bg-slate-800 rounded-2xl p-6 max-w-md w-full shadow-2xl">
              <div className="flex items-center justify-between mb-4">
                <h3 className="text-xl font-bold text-slate-900 dark:text-white flex items-center">
                  <Key className="mr-2" size={20} />
                  Gemini API Key
                </h3>
                <button
                  onClick={onClose}
                  className="p-1 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-full"
                >
                  <X size={20} />
                </button>
              </div>
              
              <p className="text-slate-600 dark:text-slate-400 mb-4 text-sm">
                Get your free API key from{' '}
                <a 
                  href="https://makersuite.google.com/app/apikey" 
                  target="_blank" 
                  rel="noopener noreferrer"
                  className="text-indigo-600 dark:text-indigo-400 underline"
                >
                  Google AI Studio
                </a>
                . Your key is stored locally in your browser and never sent to our servers.
              </p>
              
              <div className="mb-4">
                <div className="flex items-center justify-between mb-1">
                  <label className="text-sm font-medium text-slate-700 dark:text-slate-300">
                    API Key
                  </label>
                  <button
                    onClick={() => setShowKey(!showKey)}
                    className="text-xs text-indigo-600 dark:text-indigo-400"
                  >
                    {showKey ? 'Hide' : 'Show'}
                  </button>
                </div>
                <input
                  type={showKey ? "text" : "password"}
                  value={apiKey}
                  onChange={(e) => setApiKey(e.target.value)}
                  className="w-full px-4 py-3 bg-slate-50 dark:bg-slate-900 border border-slate-300 dark:border-slate-600 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                  placeholder="Enter your Gemini API key"
                />
              </div>
              
              <div className="flex gap-3">
                <Button onClick={handleSave} className="flex-1">
                  Save Key
                </Button>
                <Button variant="secondary" onClick={onClose} className="flex-1">
                  Cancel
                </Button>
              </div>
            </div>
          </div>
        );
      };

      // AudioRecorder Component
      const AudioRecorder = ({ onAudioCaptured, disabled }) => {
        const [isRecording, setIsRecording] = useState(false);
        const [duration, setDuration] = useState(0);
        const [error, setError] = useState(null);
        
        const mediaRecorderRef = useRef(null);
        const chunksRef = useRef([]);
        const timerRef = useRef(null);
        const streamRef = useRef(null);

        const startRecording = useCallback(async () => {
          setError(null);
          try {
            const stream = await navigator.mediaDevices.getUserMedia({ 
              audio: {
                echoCancellation: true,
                noiseSuppression: true,
                sampleRate: 44100
              }
            });
            streamRef.current = stream;
            
            const mediaRecorder = new MediaRecorder(stream);
            mediaRecorderRef.current = mediaRecorder;
            chunksRef.current = [];

            mediaRecorder.ondataavailable = (e) => {
              if (e.data.size > 0) {
                chunksRef.current.push(e.data);
              }
            };

            mediaRecorder.onstop = () => {
              const blob = new Blob(chunksRef.current, { type: 'audio/webm' });
              const reader = new FileReader();
              reader.readAsDataURL(blob);
              reader.onloadend = () => {
                const base64String = reader.result;
                const base64 = base64String.split(',')[1];
                
                onAudioCaptured({
                  blob,
                  base64,
                  mimeType: 'audio/webm',
                  duration: duration
                });
              };
              
              if (streamRef.current) {
                streamRef.current.getTracks().forEach(track => track.stop());
                streamRef.current = null;
              }
            };

            mediaRecorder.start(1000); // Collect data every second
            setIsRecording(true);
            
            const startTime = Date.now();
            timerRef.current = window.setInterval(() => {
              setDuration(Math.floor((Date.now() - startTime) / 1000));
            }, 1000);

          } catch (err) {
            console.error("Error accessing microphone:", err);
            setError("Microphone access denied. Please allow microphone permissions in your browser settings.");
          }
        }, [onAudioCaptured, duration]);

        const stopRecording = useCallback(() => {
          if (mediaRecorderRef.current && isRecording) {
            mediaRecorderRef.current.stop();
            setIsRecording(false);
            if (timerRef.current) {
              clearInterval(timerRef.current);
              timerRef.current = null;
            }
          }
        }, [isRecording]);

        useEffect(() => {
          return () => {
            if (timerRef.current) clearInterval(timerRef.current);
            if (streamRef.current) {
              streamRef.current.getTracks().forEach(track => track.stop());
            }
          };
        }, []);

        const formatTime = (seconds) => {
          const mins = Math.floor(seconds / 60);
          const secs = seconds % 60;
          return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        };

        return (
          <div className="flex flex-col items-center justify-center p-6 bg-white dark:bg-slate-800 border-2 border-dashed border-indigo-200 dark:border-slate-700 rounded-2xl transition-all duration-300 hover:border-indigo-300 dark:hover:border-slate-600">
            <div className={`relative flex items-center justify-center w-20 h-20 mb-6 rounded-full transition-all duration-300 ${isRecording ? 'bg-red-50 dark:bg-red-900/20' : 'bg-indigo-50 dark:bg-indigo-900/30'}`}>
              {isRecording && (
                <>
                  <span className="absolute inline-flex h-full w-full rounded-full bg-red-400 opacity-20 animate-ping"></span>
                  <span className="absolute inline-flex h-full w-full rounded-full bg-red-400 opacity-10"></span>
                </>
              )}
              {isRecording ? (
                  <div className="text-red-500 dark:text-red-400">
                      <Mic size={32} className="animate-pulse" />
                  </div>
              ) : (
                  <div className="text-indigo-500 dark:text-indigo-400">
                      <Mic size={32} />
                  </div>
              )}
            </div>

            <div className="text-center mb-6">
              {isRecording ? (
                <div>
                  <h3 className="text-lg font-semibold text-slate-800 dark:text-white">Recording...</h3>
                  <p className="text-3xl font-mono text-slate-600 dark:text-slate-300 mt-2">{formatTime(duration)}</p>
                  <p className="text-sm text-slate-500 dark:text-slate-400 mt-2">Click stop when finished</p>
                </div>
              ) : (
                <div>
                  <h3 className="text-lg font-semibold text-slate-800 dark:text-white">Ready to Record</h3>
                  <p className="text-slate-500 dark:text-slate-400 text-sm mt-1">Click the button below to start</p>
                </div>
              )}
            </div>

            {error && (
              <div className="flex items-center text-red-600 dark:text-red-400 bg-red-50 dark:bg-red-900/20 px-4 py-3 rounded-lg mb-4 text-sm w-full">
                <AlertCircle size={16} className="mr-2 flex-shrink-0" />
                <span>{error}</span>
              </div>
            )}

            {!isRecording ? (
              <Button 
                onClick={startRecording} 
                disabled={disabled}
                icon={<Mic size={18} />}
                className="w-full max-w-xs"
              >
                Start Recording
              </Button>
            ) : (
              <Button 
                onClick={stopRecording} 
                variant="danger"
                icon={<Square size={18} />}
                className="w-full max-w-xs"
              >
                Stop Recording ({formatTime(duration)})
              </Button>
            )}
          </div>
        );
      };

      // FileUploader Component
      const FileUploader = ({ onFileSelected, disabled }) => {
        const [dragActive, setDragActive] = useState(false);
        const [fileName, setFileName] = useState(null);
        const inputRef = useRef(null);

        const processFile = (file) => {
          if (file.size > 20 * 1024 * 1024) { // 20MB limit
            alert("File size too large. Please upload a file smaller than 20MB.");
            return;
          }

          if (!file.type.startsWith('audio/') && !file.type.startsWith('video/')) {
            alert("Please upload a valid audio or video file.");
            return;
          }

          setFileName(file.name);

          const reader = new FileReader();
          reader.readAsDataURL(file);
          reader.onloadend = () => {
            const base64String = reader.result;
            const base64 = base64String.split(',')[1];
            
            onFileSelected({
              blob: file,
              base64,
              mimeType: file.type,
              name: file.name
            });
          };
        };

        const handleDrag = (e) => {
          e.preventDefault();
          e.stopPropagation();
          if (e.type === "dragenter" || e.type === "dragover") {
            setDragActive(true);
          } else if (e.type === "dragleave") {
            setDragActive(false);
          }
        };

        const handleDrop = (e) => {
          e.preventDefault();
          e.stopPropagation();
          setDragActive(false);
          if (e.dataTransfer.files && e.dataTransfer.files[0]) {
            processFile(e.dataTransfer.files[0]);
          }
        };

        const handleChange = (e) => {
          if (e.target.files && e.target.files[0]) {
            processFile(e.target.files[0]);
          }
        };

        const handleClear = () => {
          setFileName(null);
          if (inputRef.current) inputRef.current.value = "";
        };

        return (
          <div className="w-full">
            <input
              ref={inputRef}
              type="file"
              className="hidden"
              accept="audio/*,video/*,.mp3,.wav,.m4a,.webm,.mp4,.ogg"
              onChange={handleChange}
              disabled={disabled}
            />
            
            {!fileName ? (
              <div
                role="button"
                tabIndex={disabled ? -1 : 0}
                aria-label="Upload audio file"
                className={`flex flex-col items-center justify-center p-10 border-2 border-dashed rounded-2xl transition-all outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 dark:focus:ring-offset-slate-900 ${
                  dragActive 
                    ? "border-indigo-500 bg-indigo-50 dark:bg-indigo-900/20" 
                    : "border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-800 hover:border-indigo-400 dark:hover:border-indigo-500 hover:bg-slate-50 dark:hover:bg-slate-800/80"
                } ${disabled ? 'opacity-50 cursor-not-allowed' : 'cursor-pointer'}`}
                onDragEnter={handleDrag}
                onDragLeave={handleDrag}
                onDragOver={handleDrag}
                onDrop={handleDrop}
                onClick={() => !disabled && inputRef.current?.click()}
              >
                <div className="p-4 bg-indigo-50 dark:bg-indigo-900/30 text-indigo-500 dark:text-indigo-400 rounded-full mb-4 animate-float">
                  <UploadCloud size={32} />
                </div>
                <p className="text-lg font-medium text-slate-700 dark:text-slate-200 mb-1">
                  Click to upload or drag & drop
                </p>
                <p className="text-sm text-slate-500 dark:text-slate-400">
                  MP3, WAV, M4A, WEBM, MP4 (Max 20MB)
                </p>
              </div>
            ) : (
              <div className="bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-xl p-5 flex items-center justify-between shadow-sm transition-colors duration-300 hover:shadow-md">
                <div className="flex items-center space-x-4">
                  <div className="p-3 bg-indigo-100 dark:bg-indigo-900/40 text-indigo-600 dark:text-indigo-400 rounded-lg">
                    <FileAudio size={24} />
                  </div>
                  <div>
                    <p className="font-medium text-slate-800 dark:text-slate-200 truncate max-w-[200px] sm:max-w-md">{fileName}</p>
                    <p className="text-xs text-slate-500 dark:text-slate-400">Ready to transcribe</p>
                  </div>
                </div>
                <button 
                  onClick={handleClear}
                  className="p-2 text-slate-400 dark:text-slate-500 hover:text-red-500 dark:hover:text-red-400 hover:bg-red-50 dark:hover:bg-red-900/20 rounded-full transition-colors focus:outline-none focus:ring-2 focus:ring-red-500"
                  disabled={disabled}
                  aria-label="Remove file"
                >
                  <X size={20} />
                </button>
              </div>
            )}
          </div>
        );
      };

      // TranscriptionDisplay Component
      const TranscriptionDisplay = ({ data }) => {
        const [copied, setCopied] = useState(false);

        const getEmotionBadge = (emotion) => {
          if (!emotion) return null;

          switch (emotion) {
            case Emotion.Happy:
              return (
                <div className="flex items-center bg-green-50 dark:bg-green-900/30 text-green-700 dark:text-green-300 px-3 py-1 rounded-full border border-green-100 dark:border-green-800 text-sm">
                  <Smile size={14} className="mr-1.5" />
                  {emotion}
                </div>
              );
            case Emotion.Sad:
              return (
                <div className="flex items-center bg-blue-50 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300 px-3 py-1 rounded-full border border-blue-100 dark:border-blue-800 text-sm">
                  <Frown size={14} className="mr-1.5" />
                  {emotion}
                </div>
              );
            case Emotion.Angry:
              return (
                <div className="flex items-center bg-red-50 dark:bg-red-900/30 text-red-700 dark:text-red-300 px-3 py-1 rounded-full border border-red-100 dark:border-red-800 text-sm">
                  <AlertCircle size={14} className="mr-1.5" />
                  {emotion}
                </div>
              );
            case Emotion.Neutral:
            default:
              return (
                <div className="flex items-center bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-300 px-3 py-1 rounded-full border border-slate-200 dark:border-slate-600 text-sm">
                  <Meh size={14} className="mr-1.5" />
                  {emotion}
                </div>
              );
          }
        };

        const copyToClipboard = () => {
          const textToCopy = `Summary:\n${data.summary}\n\nTranscript:\n${data.segments.map(s => `[${s.timestamp}] ${s.speaker}: ${s.content}${s.translation ? ` (Translation: ${s.translation})` : ''}`).join('\n')}`;
          
          navigator.clipboard.writeText(textToCopy).then(() => {
            setCopied(true);
            setTimeout(() => setCopied(false), 2000);
          });
        };

        const downloadTranscript = () => {
          const textContent = `ECHOSCRIPT AI TRANSCRIPTION\n================================\n\nSUMMARY:\n${data.summary}\n\nDETAILED TRANSCRIPT:\n\n${data.segments.map((segment, i) => `${i+1}. [${segment.timestamp}] ${segment.speaker}\n   Content: ${segment.content}\n   Language: ${segment.language}\n   Emotion: ${segment.emotion}${segment.translation ? `\n   Translation: ${segment.translation}` : ''}\n`).join('\n')}`;
          
          const blob = new Blob([textContent], { type: 'text/plain' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `transcript-${new Date().toISOString().slice(0,10)}.txt`;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(url);
        };

        return (
          <div className="space-y-8 animate-in fade-in slide-in-from-bottom-4 duration-500">
            {/* Summary Section */}
            <div className="bg-gradient-to-br from-indigo-50 to-white dark:from-slate-800 dark:to-slate-900 border border-indigo-100 dark:border-slate-700 rounded-2xl p-6 shadow-sm">
              <div className="flex justify-between items-start mb-4">
                <h2 className="text-xl font-bold text-indigo-900 dark:text-indigo-200 flex items-center">
                  <Sparkles className="mr-2" size={20} />
                  Summary
                </h2>
                <div className="flex gap-2">
                  <Button 
                    onClick={copyToClipboard} 
                    variant="secondary" 
                    className="text-sm"
                  >
                    {copied ? 'Copied!' : 'Copy'}
                  </Button>
                  <Button 
                    onClick={downloadTranscript}
                    variant="secondary"
                    icon={<Download size={16} />}
                    className="text-sm"
                  >
                    Download
                  </Button>
                </div>
              </div>
              <p className="text-slate-700 dark:text-slate-300 leading-relaxed text-lg">{data.summary}</p>
            </div>

            {/* Segments Section */}
            <div className="space-y-4">
              <h2 className="text-xl font-bold text-slate-900 dark:text-white px-1 flex items-center">
                <User className="mr-2" size={20} />
                Detailed Transcript ({data.segments.length} segments)
              </h2>
              
              {data.segments.map((segment, index) => (
                <div 
                  key={index} 
                  className="bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-xl p-5 hover:shadow-md transition-all duration-300 hover:border-indigo-200 dark:hover:border-slate-600"
                >
                  <div className="flex flex-wrap items-center gap-3 mb-4 text-sm">
                    <div className="flex items-center font-semibold text-indigo-600 dark:text-indigo-300 bg-indigo-50 dark:bg-indigo-900/40 px-3 py-1.5 rounded-full">
                      <User size={14} className="mr-1.5" />
                      {segment.speaker}
                    </div>
                    <div className="flex items-center bg-slate-100 dark:bg-slate-700 px-3 py-1.5 rounded-full">
                      <Clock size={14} className="mr-1.5" />
                      {segment.timestamp}
                    </div>
                    <div className="flex items-center bg-slate-100 dark:bg-slate-700 px-3 py-1.5 rounded-full">
                      <Globe size={14} className="mr-1.5" />
                      {segment.language}
                    </div>
                    {segment.emotion && getEmotionBadge(segment.emotion)}
                  </div>
                  
                  <p className="text-slate-800 dark:text-slate-200 leading-relaxed whitespace-pre-wrap text-lg mb-3">
                    {segment.content}
                  </p>

                  {segment.translation && (
                    <div className="mt-4 pt-4 border-t border-slate-100 dark:border-slate-700 bg-slate-50/50 dark:bg-slate-900/30 -mx-5 -mb-5 px-5 pb-5 rounded-b-xl">
                       <div className="flex items-center text-sm font-semibold text-indigo-600 dark:text-indigo-300 mb-2 uppercase tracking-wide">
                          <Languages size={16} className="mr-2" />
                          English Translation
                       </div>
                       <p className="text-slate-600 dark:text-slate-400 italic leading-relaxed">
                         {segment.translation}
                       </p>
                    </div>
                  )}
                </div>
              ))}
            </div>
          </div>
        );
      };

      // --- MAIN APP COMPONENT ---
      function App() {
        const [mode, setMode] = useState('record');
        const [status, setStatus] = useState('idle'); // idle, processing, success, error
        const [audioData, setAudioData] = useState(null);
        const [result, setResult] = useState(null);
        const [error, setError] = useState(null);
        const [showApiKeyModal, setShowApiKeyModal] = useState(false);
        
        // Dark Mode State
        const [isDarkMode, setIsDarkMode] = useState(() => {
          if (typeof window !== 'undefined') {
            const saved = localStorage.getItem('darkMode');
            return saved ? JSON.parse(saved) : window.matchMedia('(prefers-color-scheme: dark)').matches;
          }
          return false;
        });

        // Check API key on mount
        useEffect(() => {
          const hasApiKey = !!getApiKey();
          if (!hasApiKey) {
            // Show API key modal after a brief delay if no key is set
            const timer = setTimeout(() => {
              setShowApiKeyModal(true);
            }, 1000);
            return () => clearTimeout(timer);
          }
        }, []);

        // Dark Mode Effect
        useEffect(() => {
          if (isDarkMode) {
            document.documentElement.classList.add('dark');
            localStorage.setItem('darkMode', 'true');
            document.querySelector('meta[name="theme-color"]')?.setAttribute('content', '#0f172a');
          } else {
            document.documentElement.classList.remove('dark');
            localStorage.setItem('darkMode', 'false');
            document.querySelector('meta[name="theme-color"]')?.setAttribute('content', '#ffffff');
          }
        }, [isDarkMode]);

        const toggleDarkMode = () => setIsDarkMode(!isDarkMode);

        const handleAudioReady = (data) => {
          setAudioData(data);
          setError(null);
          setResult(null);
        };

        const handleTranscribe = async () => {
          if (!audioData) return;
          
          // Check for API key
          if (!getApiKey()) {
            setShowApiKeyModal(true);
            return;
          }
          
          setStatus('processing');
          setError(null);
          try {
            const data = await transcribeAudio(audioData.base64, audioData.mimeType);
            setResult(data);
            setStatus('success');
          } catch (err) {
            console.error(err);
            setError(err.message || "An unexpected error occurred during transcription.");
            setStatus('error');
          }
        };

        const handleReset = () => {
          setAudioData(null);
          setResult(null);
          setStatus('idle');
          setError(null);
        };

        const handleSaveApiKey = (key) => {
          setApiKey(key);
          // If we were trying to transcribe, retry
          if (status === 'processing' || audioData) {
            handleTranscribe();
          }
        };

        const handleShare = async () => {
          const shareData = {
            title: 'EchoScript AI - Audio Transcription',
            text: 'Transcribe audio with speaker identification, emotion detection, and multilingual support.',
            url: window.location.href,
          };

          try {
            if (navigator.share) {
              await navigator.share(shareData);
            } else {
              // Fallback: copy URL to clipboard
              await navigator.clipboard.writeText(window.location.href);
              alert('Link copied to clipboard!');
            }
          } catch (err) {
            console.log('Sharing cancelled or failed:', err);
          }
        };

        return (
          <div className="min-h-screen bg-slate-50 dark:bg-slate-950 text-slate-900 dark:text-slate-100 pb-20 transition-colors duration-300">
            {/* API Key Modal */}
            <ApiKeyModal 
              isOpen={showApiKeyModal}
              onClose={() => setShowApiKeyModal(false)}
              onSave={handleSaveApiKey}
            />

            {/* Header */}
            <header className="bg-white dark:bg-slate-900 border-b border-slate-200 dark:border-slate-800 sticky top-0 z-40 shadow-sm">
              <div className="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 h-16 flex items-center justify-between">
                <div className="flex items-center space-x-3">
                  <div className="bg-gradient-to-r from-indigo-600 to-violet-600 p-2 rounded-xl text-white shadow-lg shadow-indigo-500/30">
                    <Sparkles size={22} />
                  </div>
                  <div>
                    <h1 className="text-xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-indigo-600 to-violet-600 dark:from-indigo-400 dark:to-violet-400">
                      EchoScript AI
                    </h1>
                    <p className="text-xs text-slate-500 dark:text-slate-400 hidden sm:block">
                      Audio Transcription with AI
                    </p>
                  </div>
                </div>
                <div className="flex items-center space-x-2">
                  <button
                    onClick={() => setShowApiKeyModal(true)}
                    className="p-2 text-slate-500 dark:text-slate-400 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-lg transition-colors focus:outline-none focus:ring-2 focus:ring-indigo-500"
                    aria-label="API Settings"
                    title="API Settings"
                  >
                    <Key size={20} />
                  </button>
                  
                  <button
                    onClick={handleShare}
                    className="p-2 text-slate-500 dark:text-slate-400 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-lg transition-colors focus:outline-none focus:ring-2 focus:ring-indigo-500"
                    aria-label="Share"
                    title="Share"
                  >
                    <Share2 size={20} />
                  </button>

                  <button
                    onClick={toggleDarkMode}
                    className="p-2 text-slate-500 dark:text-slate-400 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-lg transition-colors focus:outline-none focus:ring-2 focus:ring-indigo-500"
                    aria-label="Toggle Dark Mode"
                  >
                    {isDarkMode ? <Sun size={20} /> : <Moon size={20} />}
                  </button>
                </div>
              </div>
            </header>

            <main className="max-w-4xl mx-auto px-4 sm:px-6 py-8 sm:py-12">
              
              {/* Hero Section */}
              <div className="text-center mb-10 sm:mb-12">
                <h1 className="text-3xl sm:text-4xl font-bold text-slate-900 dark:text-white mb-4">
                  Turn Audio into <span className="text-indigo-600 dark:text-indigo-400">Detailed Transcripts</span>
                </h1>
                <p className="text-lg text-slate-600 dark:text-slate-400 max-w-2xl mx-auto">
                  Upload audio files or record directly to get transcripts with speaker identification, timestamps, emotion detection, and multilingual support.
                </p>
              </div>

              {/* API Key Warning */}
              {!getApiKey() && (
                <div className="mb-6 bg-amber-50 dark:bg-amber-900/20 border border-amber-200 dark:border-amber-800 rounded-xl p-4 flex items-start">
                  <AlertTriangle className="mr-3 flex-shrink-0 mt-0.5 text-amber-600 dark:text-amber-400" size={20} />
                  <div>
                    <p className="text-amber-800 dark:text-amber-300 font-medium">API Key Required</p>
                    <p className="text-amber-700 dark:text-amber-400 text-sm mt-1">
                      You need a Gemini API key to use transcription. 
                      <button 
                        onClick={() => setShowApiKeyModal(true)}
                        className="ml-1 underline font-medium"
                      >
                        Click here to set it up
                      </button>
                    </p>
                  </div>
                </div>
              )}

              {/* Status Error */}
              {status === 'error' && error && (
                <div className="mb-6 bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-xl p-4 flex items-start">
                  <AlertTriangle className="mr-3 flex-shrink-0 mt-0.5 text-red-600 dark:text-red-400" size={20} />
                  <div>
                    <p className="text-red-800 dark:text-red-300 font-medium">Transcription Error</p>
                    <p className="text-red-700 dark:text-red-400 text-sm mt-1">{error}</p>
                    {error.includes('API Key') && (
                      <button 
                        onClick={() => setShowApiKeyModal(true)}
                        className="mt-2 text-sm underline font-medium"
                      >
                        Update API Key
                      </button>
                    )}
                  </div>
                </div>
              )}

              {/* Input Selection Tabs */}
              {!result && status !== 'processing' && (
                  <div className="bg-white dark:bg-slate-900 p-1 rounded-xl shadow-sm border border-slate-200 dark:border-slate-800 flex mb-8 transition-colors duration-300">
                  <button
                      onClick={() => { setMode('record'); handleReset(); }}
                      className={`flex-1 flex items-center justify-center px-4 sm:px-6 py-3 rounded-lg text-sm font-medium transition-all focus:outline-none focus:ring-2 focus:ring-offset-1 dark:focus:ring-offset-slate-900 focus:ring-indigo-500 ${
                      mode === 'record' 
                          ? 'bg-indigo-600 text-white shadow-sm' 
                          : 'text-slate-600 dark:text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-800'
                      }`}
                      disabled={status === 'processing'}
                  >
                      <Mic size={16} className="mr-2" />
                      Record
                  </button>
                  <button
                      onClick={() => { setMode('upload'); handleReset(); }}
                      className={`flex-1 flex items-center justify-center px-4 sm:px-6 py-3 rounded-lg text-sm font-medium transition-all focus:outline-none focus:ring-2 focus:ring-offset-1 dark:focus:ring-offset-slate-900 focus:ring-indigo-500 ${
                      mode === 'upload' 
                          ? 'bg-indigo-600 text-white shadow-sm' 
                          : 'text-slate-600 dark:text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-800'
                      }`}
                      disabled={status === 'processing'}
                  >
                      <Upload size={16} className="mr-2" />
                      Upload
                  </button>
                  </div>
              )}

              {/* Main Content Area */}
              <div className="space-y-8">
                
                {/* Input Section */}
                {!result && status !== 'processing' && (
                  <div className="bg-white dark:bg-slate-900 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-800 p-6 sm:p-8">
                    {mode === 'record' ? (
                      <AudioRecorder onAudioCaptured={handleAudioReady} disabled={status === 'processing'} />
                    ) : (
                      <FileUploader onFileSelected={handleAudioReady} disabled={status === 'processing'} />
                    )}

                    {audioData && (
                      <div className="mt-8 pt-6 border-t border-slate-100 dark:border-slate-800 flex flex-col sm:flex-row justify-between items-center gap-4">
                        <div className="text-sm text-slate-500 dark:text-slate-400">
                          {mode === 'record' ? 'Recording captured' : 'File ready'} â€¢ Click to transcribe
                        </div>
                        <div className="flex gap-3 w-full sm:w-auto">
                          <Button 
                            onClick={handleReset}
                            variant="secondary"
                            className="flex-1 sm:flex-none"
                          >
                            Clear
                          </Button>
                          <Button 
                            onClick={handleTranscribe} 
                            isLoading={status === 'processing'}
                            icon={<Sparkles size={18} />}
                            className="flex-1 sm:flex-none"
                            disabled={!getApiKey()}
                          >
                            Transcribe Audio
                          </Button>
                        </div>
                      </div>
                    )}
                  </div>
                )}

                {/* Processing State */}
                {status === 'processing' && (
                  <div className="bg-white dark:bg-slate-900 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-800 p-10 sm:p-12 text-center">
                    <div className="flex justify-center mb-6">
                       <div className="relative">
                          <div className="w-20 h-20 border-4 border-indigo-100 dark:border-indigo-900 border-t-indigo-600 dark:border-t-indigo-500 rounded-full animate-spin"></div>
                          <div className="absolute top-0 left-0 w-full h-full flex items-center justify-center">
                              <Sparkles size={28} className="text-indigo-600 dark:text-indigo-400 animate-pulse-slow" />
                          </div>
                       </div>
                    </div>
                    <h3 className="text-xl font-semibold text-slate-900 dark:text-white mb-3">Processing Audio...</h3>
                    <p className="text-slate-500 dark:text-slate-400 max-w-sm mx-auto">
                      Gemini AI is analyzing your audio. This may take 10-30 seconds depending on length.
                    </p>
                    <div className="mt-6 inline-flex items-center text-sm text-slate-400">
                      <div className="h-1 w-24 bg-slate-200 dark:bg-slate-700 rounded-full overflow-hidden">
                        <div className="h-full bg-indigo-500 animate-pulse w-3/4"></div>
                      </div>
                      <span className="ml-3">Processing</span>
                    </div>
                  </div>
                )}

                {/* Results Section */}
                {result && status === 'success' && (
                  <div className="animate-in fade-in duration-500">
                      <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-8 gap-4">
                          <div>
                            <h2 className="text-2xl font-bold text-slate-900 dark:text-white">Transcription Complete</h2>
                            <p className="text-slate-500 dark:text-slate-400 mt-1">
                              {result.segments.length} segments â€¢ {result.summary.length > 100 ? 'Detailed' : 'Brief'} summary
                            </p>
                          </div>
                          <div className="flex gap-3 w-full sm:w-auto">
                            <Button onClick={handleReset} variant="secondary">
                              Start New
                            </Button>
                            <Button 
                              onClick={() => {
                                const textToCopy = `Summary:\n${result.summary}\n\nTranscript:\n${result.segments.map(s => `[${s.timestamp}] ${s.speaker}: ${s.content}`).join('\n')}`;
                                navigator.clipboard.writeText(textToCopy);
                              }}
                              variant="primary"
                            >
                              Copy All
                            </Button>
                          </div>
                      </div>
                      <TranscriptionDisplay data={result} />
                  </div>
                )}
              </div>

              {/* Features & Info */}
              <div className="mt-16 grid grid-cols-1 sm:grid-cols-3 gap-6">
                <div className="bg-white dark:bg-slate-800 p-5 rounded-xl border border-slate-200 dark:border-slate-700">
                  <div className="p-2 bg-indigo-100 dark:bg-indigo-900/30 text-indigo-600 dark:text-indigo-400 rounded-lg w-fit mb-4">
                    <User size={20} />
                  </div>
                  <h3 className="font-semibold text-slate-900 dark:text-white mb-2">Speaker Identification</h3>
                  <p className="text-sm text-slate-600 dark:text-slate-400">Automatically detects different speakers in conversations</p>
                </div>
                <div className="bg-white dark:bg-slate-800 p-5 rounded-xl border border-slate-200 dark:border-slate-700">
                  <div className="p-2 bg-indigo-100 dark:bg-indigo-900/30 text-indigo-600 dark:text-indigo-400 rounded-lg w-fit mb-4">
                    <Globe size={20} />
                  </div>
                  <h3 className="font-semibold text-slate-900 dark:text-white mb-2">Multilingual</h3>
                  <p className="text-sm text-slate-600 dark:text-slate-400">Supports 100+ languages with automatic translation</p>
                </div>
                <div className="bg-white dark:bg-slate-800 p-5 rounded-xl border border-slate-200 dark:border-slate-700">
                  <div className="p-2 bg-indigo-100 dark:bg-indigo-900/30 text-indigo-600 dark:text-indigo-400 rounded-lg w-fit mb-4">
                    <Smile size={20} />
                  </div>
                  <h3 className="font-semibold text-slate-900 dark:text-white mb-2">Emotion Detection</h3>
                  <p className="text-sm text-slate-600 dark:text-slate-400">Identifies speaker emotions (Happy, Sad, Angry, Neutral)</p>
                </div>
              </div>

              {/* Footer & Disclaimer */}
              <div className="mt-16 text-center text-xs text-slate-500 dark:text-slate-400 max-w-2xl mx-auto leading-relaxed border-t border-slate-200 dark:border-slate-800 pt-8">
                  <p className="mb-3">
                    This tool uses Google's Gemini AI for transcription. Your audio is processed directly by Google's servers.
                    Your API key is stored locally in your browser and never sent to any server except Google's.
                  </p>
                  <p className="mb-4">
                    By using this tool, you agree to Google's{' '}
                    <a href="https://policies.google.com/terms/generative-ai/use-policy" target="_blank" rel="noopener noreferrer" className="underline hover:text-slate-700 dark:hover:text-slate-300 transition-colors">
                      Generative AI Prohibited Use Policy
                    </a>.
                  </p>
                  <p>
                    Â© {new Date().getFullYear()} EchoScript AI â€¢ 
                    <a href="https://github.com" target="_blank" rel="noopener noreferrer" className="ml-1 underline hover:text-slate-700 dark:hover:text-slate-300 transition-colors">
                      Open Source Project
                    </a>
                  </p>
              </div>

            </main>
          </div>
        );
      }

      // Initialize React App
      const rootElement = document.getElementById('root');
      if (!rootElement) {
        console.error("Root element not found");
        document.body.innerHTML = '<div class="p-8 text-center text-red-600">Error: Could not find root element</div>';
      } else {
        try {
          const root = ReactDOM.createRoot(rootElement);
          root.render(
            <React.StrictMode>
              <App />
            </React.StrictMode>
          );
        } catch (error) {
          console.error("Failed to render React app:", error);
          rootElement.innerHTML = `
            <div class="min-h-screen flex items-center justify-center p-8">
              <div class="text-center max-w-md">
                <h1 class="text-2xl font-bold text-red-600 mb-4">Application Error</h1>
                <p class="text-slate-600 mb-4">Failed to load the application. Please check your browser console for details.</p>
                <p class="text-sm text-slate-500">Error: ${error.message}</p>
              </div>
            </div>
          `;
        }
      }
    </script>
  </body>
</html>

<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#ffffff">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>WHO Growth Tracker</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        /* Mobile Native Feel */
        body {
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            user-select: none;
            -webkit-user-select: none;
            overscroll-behavior-y: none;
        }
        
        /* Input needs to be selectable */
        input, textarea {
            user-select: text;
            -webkit-user-select: text;
        }

        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 4px; height: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        
        /* Safe area for iPhone X+ */
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
        .pt-safe { padding-top: env(safe-area-inset-top); }
    </style>

    <!-- Import Map to resolve modules in browser -->
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "@google/genai": "https://esm.sh/@google/genai@0.1.1",
        "recharts": "https://esm.sh/recharts@2.12.0",
        "lucide-react": "https://esm.sh/lucide-react@0.330.0"
      }
    }
    </script>

    <!-- PWA Injector Script -->
    <script>
        (function() {
            // 1. Create Manifest Blob
            const manifest = {
                "name": "WHO Growth",
                "short_name": "WHO Growth",
                "start_url": ".",
                "display": "standalone",
                "background_color": "#ffffff",
                "theme_color": "#0d9488",
                "icons": [
                    {
                        "src": "https://cdn-icons-png.flaticon.com/512/3063/3063176.png",
                        "sizes": "192x192",
                        "type": "image/png"
                    }
                ],
                "orientation": "portrait"
            };
            const manifestBlob = new Blob([JSON.stringify(manifest)], {type: 'application/json'});
            const manifestURL = URL.createObjectURL(manifestBlob);
            
            // Inject Link Tag
            const link = document.createElement('link');
            link.rel = 'manifest';
            link.href = manifestURL;
            document.head.appendChild(link);

            // 2. Dummy Service Worker for PWA Criteria
            if ('serviceWorker' in navigator) {
                const swContent = "self.addEventListener('fetch', () => {}); self.addEventListener('install', () => self.skipWaiting());";
                const swBlob = new Blob([swContent], {type: 'text/javascript'});
                const swUrl = URL.createObjectURL(swBlob);
                navigator.serviceWorker.register(swUrl).catch(console.error);
            }

            // 3. Polyfill process.env for Gemini
            window.process = { env: { API_KEY: '' } }; // User must enter key in code or we prompt
        })();
    </script>
</head>
<body class="bg-slate-50 text-slate-900 antialiased selection:bg-teal-100 selection:text-teal-900 h-screen overflow-hidden flex flex-col">
    <div id="root" class="flex-1 h-full w-full"></div>

    <!-- MAIN APPLICATION LOGIC -->
    <script type="text/babel" data-type="module">
        import React, { useState, useMemo } from 'react';
        import ReactDOM from 'react-dom/client';
        import { 
            Trash2, Activity, Share2, AlertCircle, Baby, Stethoscope, 
            Save, Home, BarChart2, History, ChevronDown, RotateCcw, 
            Info, CheckCircle, AlertTriangle, Minus, Plus 
        } from 'lucide-react';
        import { 
            ComposedChart, Line, Area, XAxis, YAxis, CartesianGrid, 
            Tooltip, Legend, ResponsiveContainer, ReferenceDot 
        } from 'recharts';
        import { GoogleGenAI } from "@google/genai";

        // ==========================================
        // 1. DATA & STANDARDS (Embedded)
        // ==========================================
        
        const boysWeight = [
            { month: 0, sd3neg: 2.1, sd2neg: 2.5, sd0: 3.3, sd2: 4.4, sd3: 5.0 },
            { month: 3, sd3neg: 4.4, sd2neg: 5.0, sd0: 6.4, sd2: 8.0, sd3: 9.0 },
            { month: 6, sd3neg: 5.7, sd2neg: 6.4, sd0: 7.9, sd2: 9.8, sd3: 10.9 },
            { month: 9, sd3neg: 6.5, sd2neg: 7.1, sd0: 8.9, sd2: 10.9, sd3: 12.1 },
            { month: 12, sd3neg: 7.0, sd2neg: 7.7, sd0: 9.6, sd2: 11.8, sd3: 13.1 },
            { month: 18, sd3neg: 7.8, sd2neg: 8.8, sd0: 10.9, sd2: 13.5, sd3: 14.8 },
            { month: 24, sd3neg: 8.6, sd2neg: 9.7, sd0: 12.2, sd2: 15.3, sd3: 17.0 },
            { month: 36, sd3neg: 10.0, sd2neg: 11.3, sd0: 14.3, sd2: 18.3, sd3: 20.7 },
            { month: 48, sd3neg: 11.2, sd2neg: 12.7, sd0: 16.3, sd2: 21.2, sd3: 24.5 },
            { month: 60, sd3neg: 12.4, sd2neg: 14.1, sd0: 18.3, sd2: 24.2, sd3: 28.5 },
        ];

        const girlsWeight = [
            { month: 0, sd3neg: 2.0, sd2neg: 2.4, sd0: 3.2, sd2: 4.2, sd3: 4.8 },
            { month: 3, sd3neg: 4.0, sd2neg: 4.5, sd0: 5.8, sd2: 7.3, sd3: 8.2 },
            { month: 6, sd3neg: 5.1, sd2neg: 5.7, sd0: 7.3, sd2: 9.1, sd3: 10.2 },
            { month: 9, sd3neg: 5.8, sd2neg: 6.5, sd0: 8.2, sd2: 10.2, sd3: 11.5 },
            { month: 12, sd3neg: 6.3, sd2neg: 7.0, sd0: 8.9, sd2: 11.2, sd3: 12.6 },
            { month: 18, sd3neg: 7.2, sd2neg: 8.1, sd0: 10.2, sd2: 12.8, sd3: 14.5 },
            { month: 24, sd3neg: 8.1, sd2neg: 9.0, sd0: 11.5, sd2: 14.6, sd3: 16.6 },
            { month: 36, sd3neg: 9.6, sd2neg: 10.8, sd0: 13.9, sd2: 18.1, sd3: 20.9 },
            { month: 48, sd3neg: 10.9, sd2neg: 12.3, sd0: 16.1, sd2: 21.5, sd3: 25.4 },
            { month: 60, sd3neg: 12.1, sd2neg: 13.7, sd0: 18.2, sd2: 24.9, sd3: 30.0 },
        ];

        const boysHeight = [
            { month: 0, sd3neg: 44.2, sd2neg: 46.1, sd0: 49.9, sd2: 53.7, sd3: 55.6 },
            { month: 3, sd3neg: 55.6, sd2neg: 57.6, sd0: 61.4, sd2: 65.2, sd3: 67.2 },
            { month: 6, sd3neg: 61.2, sd2neg: 63.3, sd0: 67.6, sd2: 71.9, sd3: 74.0 },
            { month: 9, sd3neg: 65.0, sd2neg: 67.2, sd0: 72.0, sd2: 76.8, sd3: 79.3 },
            { month: 12, sd3neg: 68.6, sd2neg: 71.0, sd0: 75.7, sd2: 80.5, sd3: 82.9 },
            { month: 18, sd3neg: 74.8, sd2neg: 76.9, sd0: 82.3, sd2: 87.7, sd3: 90.4 },
            { month: 24, sd3neg: 80.0, sd2neg: 81.7, sd0: 87.8, sd2: 93.9, sd3: 97.0 },
            { month: 36, sd3neg: 87.4, sd2neg: 89.4, sd0: 96.1, sd2: 102.8, sd3: 106.1 },
            { month: 48, sd3neg: 93.0, sd2neg: 95.4, sd0: 103.3, sd2: 111.2, sd3: 115.2 },
            { month: 60, sd3neg: 98.4, sd2neg: 101.0, sd0: 110.0, sd2: 119.0, sd3: 123.5 },
        ];

        const girlsHeight = [
            { month: 0, sd3neg: 43.6, sd2neg: 45.4, sd0: 49.1, sd2: 52.9, sd3: 54.7 },
            { month: 3, sd3neg: 54.0, sd2neg: 55.6, sd0: 59.8, sd2: 64.0, sd3: 66.1 },
            { month: 6, sd3neg: 59.3, sd2neg: 61.2, sd0: 65.7, sd2: 70.3, sd3: 72.5 },
            { month: 9, sd3neg: 62.9, sd2neg: 65.0, sd0: 70.1, sd2: 75.2, sd3: 77.8 },
            { month: 12, sd3neg: 66.3, sd2neg: 68.9, sd0: 74.0, sd2: 79.2, sd3: 81.7 },
            { month: 18, sd3neg: 72.8, sd2neg: 74.9, sd0: 80.7, sd2: 86.5, sd3: 89.4 },
            { month: 24, sd3neg: 78.0, sd2neg: 80.0, sd0: 86.4, sd2: 92.8, sd3: 96.0 },
            { month: 36, sd3neg: 86.1, sd2neg: 88.5, sd0: 95.1, sd2: 101.7, sd3: 105.0 },
            { month: 48, sd3neg: 91.8, sd2neg: 94.7, sd0: 102.7, sd2: 110.7, sd3: 114.6 },
            { month: 60, sd3neg: 97.1, sd2neg: 99.9, sd0: 109.4, sd2: 118.9, sd3: 123.7 },
        ];

        const WHO_STANDARDS = {
            wfa: { boy: boysWeight, girl: girlsWeight },
            lhfa: { boy: boysHeight, girl: girlsHeight }
        };

        const interpolateData = (data, maxMonth = 60) => {
            const result = [];
            for (let m = 0; m <= maxMonth; m++) {
                const lower = data.filter(p => p.month <= m).pop() || data[0];
                const upper = data.find(p => p.month >= m) || data[data.length - 1];
                if (lower.month === upper.month) {
                    result.push(lower);
                } else {
                    const ratio = (m - lower.month) / (upper.month - lower.month);
                    result.push({
                        month: m,
                        sd3neg: lower.sd3neg + (upper.sd3neg - lower.sd3neg) * ratio,
                        sd2neg: lower.sd2neg + (upper.sd2neg - lower.sd2neg) * ratio,
                        sd0: lower.sd0 + (upper.sd0 - lower.sd0) * ratio,
                        sd2: lower.sd2 + (upper.sd2 - lower.sd2) * ratio,
                        sd3: lower.sd3 + (upper.sd3 - lower.sd3) * ratio,
                    });
                }
            }
            return result;
        };

        // ==========================================
        // 2. UTILS
        // ==========================================

        const calculateAgeMonths = (dob, measureDate) => {
            const birth = new Date(dob);
            const check = new Date(measureDate);
            const diffTime = Math.abs(check.getTime() - birth.getTime());
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            return parseFloat((diffDays / 30.4375).toFixed(1));
        };

        const analyzeGrowth = (age, value, gender, type) => {
            const standards = type === 'weight' ? WHO_STANDARDS.wfa : WHO_STANDARDS.lhfa;
            const rawData = gender === 'boy' ? standards.boy : standards.girl;
            const data = interpolateData(rawData, Math.ceil(age) + 1);
            
            const point = data.find(p => p.month >= age) || data[data.length - 1];
            
            let status = 'normal';
            let message = 'Phát triển bình thường';
            
            if (value < point.sd3neg) {
                status = type === 'weight' ? 'underweight' : 'stunted';
                message = type === 'weight' ? 'Suy dinh dưỡng nặng (<-3SD)' : 'Thấp còi nặng (<-3SD)';
            } else if (value < point.sd2neg) {
                status = type === 'weight' ? 'risk_underweight' : 'risk_stunted';
                message = type === 'weight' ? 'Nhẹ cân vừa (<-2SD)' : 'Thấp còi (<-2SD)';
            } else if (value > point.sd3) {
                status = 'obese';
                message = 'Rất cao/Béo phì (>+3SD)';
            } else if (value > point.sd2) {
                status = 'overweight';
                message = 'Cao/Thừa cân (>+2SD)';
            }

            let zScore = 0;
            if (value > point.sd0) {
                const diff = point.sd2 - point.sd0;
                zScore = ((value - point.sd0) / (diff / 2));
            } else {
                const diff = point.sd0 - point.sd2neg;
                zScore = ((value - point.sd0) / (diff / 2));
            }

            return { status, message, zScore };
        };

        // ==========================================
        // 3. SERVICES (Gemini)
        // ==========================================
        const getGeminiAdvice = async (age, gender, weight, height, wAnalysis, hAnalysis) => {
            if (!window.process.env.API_KEY) return "Vui lòng cấu hình API KEY trong code.";
            try {
                const ai = new GoogleGenAI({ apiKey: window.process.env.API_KEY });
                const prompt = `
                    Bạn là bác sĩ dinh dưỡng. Gợi ý ngắn cho bé:
                    - ${age} tháng, ${gender === 'boy' ? 'Nam' : 'Nữ'}
                    - ${weight}kg (${wAnalysis.message}), ${height}cm (${hAnalysis.message})
                    
                    Yêu cầu: Ngắn gọn 3 dòng, thân thiện, 2 món ăn Việt Nam gợi ý.
                `;
                const response = await ai.models.generateContent({
                    model: 'gemini-1.5-flash',
                    contents: prompt,
                });
                return response.text;
            } catch (error) {
                return "Lỗi kết nối AI. Thử lại sau.";
            }
        };

        // ==========================================
        // 4. COMPONENTS
        // ==========================================

        const ZScoreGauge = ({ zScore, label }) => {
            const clampedZ = Math.max(-4, Math.min(4, zScore));
            const percent = ((clampedZ + 4) / 8) * 100;
            let markerColor = 'bg-green-500';
            if (clampedZ < -2 || clampedZ > 2) markerColor = 'bg-orange-500';
            if (clampedZ < -3 || clampedZ > 3) markerColor = 'bg-red-500';

            return (
                <div className="w-full mt-3 select-none">
                    <div className="flex justify-between text-[10px] text-slate-400 mb-1.5 font-semibold px-[12.5%]">
                        <span className="-ml-2">-2SD</span><span className="text-slate-300">0</span><span className="-mr-2">+2SD</span>
                    </div>
                    <div className="relative h-3.5 w-full rounded-full overflow-hidden flex shadow-inner ring-1 ring-slate-100">
                        <div className="w-[12.5%] bg-red-400 h-full border-r border-white/20"></div>
                        <div className="w-[12.5%] bg-orange-300 h-full border-r border-white/20"></div>
                        <div className="w-[50%] bg-emerald-400 h-full relative border-r border-white/20"><div className="absolute left-1/2 top-0 bottom-0 w-0.5 bg-white/40"></div></div>
                        <div className="w-[12.5%] bg-orange-300 h-full border-r border-white/20"></div>
                        <div className="w-[12.5%] bg-red-400 h-full"></div>
                        <div className={`absolute top-1/2 w-4 h-4 border-[3px] border-white rounded-full shadow-md z-20 transition-all duration-1000 ease-out ${markerColor}`} style={{ left: `${percent}%`, transform: 'translate(-50%, -50%)' }}></div>
                    </div>
                    <div className="flex items-center justify-between mt-2.5">
                        <p className="text-xs font-medium text-slate-500 truncate max-w-[70%]">{label}</p>
                        <span className={`text-xs font-bold px-2 py-0.5 rounded ${clampedZ < -2 || clampedZ > 2 ? 'bg-orange-100 text-orange-700' : 'bg-emerald-100 text-emerald-700'}`}>Z: {zScore > 0 ? '+' : ''}{zScore.toFixed(2)}</span>
                    </div>
                </div>
            );
        };

        const CustomTooltip = ({ active, payload, label }) => {
            if (active && payload && payload.length) {
                const childPoint = payload.find(p => p.name === 'Trẻ' || p.name === 'Đang nhập');
                return (
                    <div className="bg-white/95 p-3 border border-slate-200 shadow-xl rounded-lg text-sm backdrop-blur-sm z-50">
                        <p className="font-bold text-slate-700 mb-1">{label} tháng</p>
                        {childPoint && (
                            <div className="text-teal-700 font-bold text-base flex items-center gap-2">
                                <span>{childPoint.name === 'Đang nhập' ? 'Dự tính:' : 'Thực tế:'}</span>
                                <span className="text-xl">{childPoint.value}</span>
                            </div>
                        )}
                    </div>
                );
            }
            return null;
        };

        const GrowthChart = ({ records, gender, type, previewData }) => {
            const chartData = useMemo(() => {
                const standardsRaw = type === 'weight' ? WHO_STANDARDS.wfa[gender] : WHO_STANDARDS.lhfa[gender];
                const recordAges = records.map(r => r.ageMonths);
                if (previewData) recordAges.push(previewData.ageMonths);
                const maxRecordAge = recordAges.length > 0 ? Math.max(...recordAges) : 0;
                const viewMaxAge = Math.min(60, Math.max(24, Math.ceil(maxRecordAge + 5)));
                return interpolateData(standardsRaw, viewMaxAge);
            }, [gender, type, records, previewData]);

            const childData = useMemo(() => {
                const data = records.map(r => ({ age: r.ageMonths, value: type === 'weight' ? r.weight : r.height, isPreview: false }));
                if (previewData) {
                    data.push({ age: previewData.ageMonths, value: type === 'weight' ? previewData.weight : previewData.height, isPreview: true });
                }
                return data.sort((a,b) => a.age - b.age);
            }, [records, previewData, type]);

            const mainColor = gender === 'boy' ? '#2563eb' : '#db2777'; 

            return (
                <div className="w-full h-[350px] md:h-[450px] bg-white rounded-2xl shadow-lg border border-slate-100 p-2 md:p-5 flex flex-col relative overflow-hidden">
                    <h3 className="text-center font-bold text-slate-700 mb-4 uppercase text-sm md:text-base tracking-wide flex items-center justify-center gap-2">
                        <span className={`w-3 h-3 rounded-full ${gender === 'boy' ? 'bg-blue-500' : 'bg-pink-500'}`}></span>
                        {type === 'weight' ? 'Cân nặng (kg)' : 'Chiều cao (cm)'}
                    </h3>
                    <div className="flex-1 w-full min-h-0">
                        <ResponsiveContainer width="100%" height="100%">
                            <ComposedChart margin={{ top: 10, right: 10, left: -10, bottom: 5 }}>
                                <defs><filter id="shadow" height="130%"><feDropShadow dx="0" dy="2" stdDeviation="2" floodColor="rgba(0,0,0,0.2)"/></filter></defs>
                                <CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#f1f5f9" />
                                <XAxis dataKey="month" type="number" domain={[0, 'auto']} tick={{fontSize: 10, fill: '#64748b', fontWeight: 600}} tickCount={8} unit="th" />
                                <YAxis domain={['auto', 'auto']} tick={{fontSize: 10, fill: '#64748b', fontWeight: 600}} width={40} />
                                <Tooltip content={<CustomTooltip />} />
                                <Legend wrapperStyle={{fontSize: '11px', paddingTop: '10px'}} iconType="circle" iconSize={8}/>
                                <Area data={chartData} type="monotone" dataKey="sd3" stroke="none" fill="#fef08a" fillOpacity={0.6} name="Cao" legendType="square"/>
                                <Area data={chartData} type="monotone" dataKey="sd2" stroke="none" fill="#bbf7d0" fillOpacity={0.9} name="Chuẩn" legendType="square"/>
                                <Area data={chartData} type="monotone" dataKey="sd2neg" stroke="none" fill="#fdba74" fillOpacity={0.9} name="Nguy cơ" legendType="square"/>
                                <Area data={chartData} type="monotone" dataKey="sd3neg" stroke="none" fill="#fca5a5" fillOpacity={0.9} name="Suy dinh dưỡng" legendType="square"/>
                                <Line data={chartData} type="basis" dataKey="sd0" stroke="#059669" dot={false} strokeWidth={1} strokeDasharray="4 4" name="Trung bình" />
                                <Line data={childData.filter(d => !d.isPreview)} dataKey="value" type="monotone" stroke={mainColor} strokeWidth={3} dot={{ r: 4, fill: mainColor, strokeWidth: 2, stroke: '#fff' }} name="Trẻ" connectNulls filter="url(#shadow)" />
                                {previewData && (
                                    <ReferenceDot x={previewData.ageMonths} y={type === 'weight' ? previewData.weight : previewData.height} r={6} fill="#fff" stroke={mainColor} strokeWidth={3} isFront={true}>
                                        <animate attributeName="r" from="6" to="10" dur="1s" begin="0s" repeatCount="indefinite" values="6; 10; 6" keyTimes="0; 0.5; 1" />
                                        <animate attributeName="stroke-opacity" from="1" to="0.5" dur="1s" repeatCount="indefinite" values="1; 0.5; 1" keyTimes="0; 0.5; 1" />
                                    </ReferenceDot>
                                )}
                            </ComposedChart>
                        </ResponsiveContainer>
                    </div>
                </div>
            );
        };

        const ChartGuide = () => (
            <div className="bg-white/80 backdrop-blur-sm p-4 rounded-xl border border-slate-200 shadow-sm mt-4 text-sm">
                <h3 className="font-bold text-slate-700 flex items-center gap-2 mb-3"><Info size={16} className="text-teal-600"/> Cách xem biểu đồ</h3>
                <div className="space-y-2">
                    <div className="flex items-center gap-3"><div className="w-4 h-4 rounded bg-[#bbf7d0] border border-green-200"></div><span className="text-slate-600"><strong>Vùng Xanh:</strong> Tốt.</span></div>
                    <div className="flex items-center gap-3"><div className="w-4 h-4 rounded bg-[#fdba74] border border-orange-200"></div><span className="text-slate-600"><strong>Vùng Cam:</strong> Nguy cơ.</span></div>
                    <div className="flex items-center gap-3"><div className="w-4 h-4 rounded bg-[#fca5a5] border border-red-200"></div><span className="text-slate-600"><strong>Vùng Đỏ:</strong> Báo động.</span></div>
                </div>
            </div>
        );

        const DateSelect = ({ label, value, onChange }) => {
            const parts = value.split('-');
            let y = parseInt(parts[0]) || new Date().getFullYear();
            let m = parseInt(parts[1]) || new Date().getMonth() + 1;
            let d = parseInt(parts[2]) || new Date().getDate();

            const years = Array.from({length: new Date().getFullYear() - 2015 + 2}, (_, i) => new Date().getFullYear() + 1 - i);
            const daysInMonth = new Date(y, m, 0).getDate();
            const days = Array.from({length: daysInMonth}, (_, i) => i + 1);
            const months = Array.from({length: 12}, (_, i) => i + 1);

            const handleChange = (type, val) => {
                let newY = y, newM = m, newD = d;
                if (type === 'y') newY = val;
                if (type === 'm') newM = val;
                if (type === 'd') newD = val;
                if (newD > new Date(newY, newM, 0).getDate()) newD = new Date(newY, newM, 0).getDate();
                onChange(`${newY}-${String(newM).padStart(2, '0')}-${String(newD).padStart(2, '0')}`);
            };

            return (
                <div className="mb-2">
                    <label className="block text-[11px] font-bold text-slate-500 mb-1.5 uppercase tracking-wider">{label}</label>
                    <div className="flex gap-2">
                        <div className="relative flex-1">
                            <select value={d} onChange={(e) => handleChange('d', parseInt(e.target.value))} className="w-full p-2.5 border border-slate-200 bg-white rounded-xl text-sm font-bold text-slate-700 outline-none focus:border-teal-500">{days.map(day => <option key={day} value={day}>{day}</option>)}</select>
                            <ChevronDown className="absolute right-2 top-3 text-slate-400 pointer-events-none" size={14} />
                        </div>
                        <div className="relative flex-[1.4]">
                            <select value={m} onChange={(e) => handleChange('m', parseInt(e.target.value))} className="w-full p-2.5 border border-slate-200 bg-white rounded-xl text-sm font-bold text-slate-700 outline-none focus:border-teal-500">{months.map(mo => <option key={mo} value={mo}>T{mo}</option>)}</select>
                            <ChevronDown className="absolute right-2 top-3 text-slate-400 pointer-events-none" size={14} />
                        </div>
                        <div className="relative flex-[1.2]">
                            <select value={y} onChange={(e) => handleChange('y', parseInt(e.target.value))} className="w-full p-2.5 border border-slate-200 bg-white rounded-xl text-sm font-bold text-slate-700 outline-none focus:border-teal-500">{years.map(yr => <option key={yr} value={yr}>{yr}</option>)}</select>
                            <ChevronDown className="absolute right-2 top-3 text-slate-400 pointer-events-none" size={14} />
                        </div>
                    </div>
                </div>
            );
        };

        const MetricInput = ({ label, value, onChange, unit, min, max, step = 0.1, analysis }) => {
            const numValue = value === '' ? (min + (max-min)/2) : parseFloat(value);
            
            const handleIncrement = (amount) => {
                const current = value === '' ? min : parseFloat(value);
                const next = Math.min(max, Math.max(min, current + amount));
                onChange(next.toFixed(1));
            };

            const getInputStyle = (status) => {
                const base = "w-full p-3 pl-3 pr-10 border rounded-xl text-xl font-bold text-slate-800 outline-none transition-all duration-300 placeholder:text-slate-300 placeholder:font-normal placeholder:text-sm shadow-sm text-center ";
                if (!status) return base + "border-slate-200 focus:border-teal-500 bg-white";
                if (status.includes('normal')) return base + "border-green-200 bg-green-50/50 focus:border-green-500";
                if (status.includes('risk') || status.includes('overweight')) return base + "border-orange-200 bg-orange-50/50 focus:border-orange-500";
                return base + "border-red-200 bg-red-50/50 focus:border-red-500";
            };

            return (
                <div className="relative group bg-white/50 rounded-2xl p-2 border border-slate-100/50">
                    <div className="flex justify-between items-center mb-2 px-1">
                        <label className="text-xs font-bold text-slate-500 uppercase tracking-wide">{label}</label>
                        {analysis && <span className={`text-[10px] font-bold px-2 py-0.5 rounded-full ${analysis.status === 'normal' ? 'text-green-600 bg-green-100' : analysis.status.includes('risk') ? 'text-orange-600 bg-orange-100' : 'text-red-600 bg-red-100'}`}>{analysis.message}</span>}
                    </div>
                    <div className="flex items-center gap-2 mb-3">
                        <button onClick={() => handleIncrement(-0.5)} className="w-10 h-10 flex items-center justify-center bg-white border border-slate-200 rounded-xl text-slate-400 hover:text-slate-700 active:bg-slate-50 shadow-sm"><Minus size={18} /></button>
                        <div className="relative flex-1">
                            <input type="number" step={step} placeholder="0.0" value={value} onChange={(e) => onChange(e.target.value)} className={getInputStyle(analysis?.status)} />
                            <span className="absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 text-xs font-bold pointer-events-none">{unit}</span>
                        </div>
                        <button onClick={() => handleIncrement(0.5)} className="w-10 h-10 flex items-center justify-center bg-white border border-slate-200 rounded-xl text-slate-400 hover:text-slate-700 active:bg-slate-50 shadow-sm"><Plus size={18} /></button>
                    </div>
                    <div className="px-1 relative h-6 flex items-center">
                        <input type="range" min={min} max={max} step={step} value={value === '' ? min : value} onChange={(e) => onChange(e.target.value)} className="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-teal-600" />
                        <div className="absolute top-5 left-0 text-[9px] font-bold text-slate-300">{min}</div>
                        <div className="absolute top-5 right-0 text-[9px] font-bold text-slate-300">{max}</div>
                    </div>
                </div>
            );
        };

        const ChildInfoSection = ({ dob, setDob, gender, setGender }) => (
            <div className="bg-white/80 backdrop-blur-md p-5 rounded-2xl border border-white/50 shadow-lg shadow-slate-200/50 mb-6 relative overflow-hidden">
                <div className="absolute top-0 right-0 p-4 opacity-10 pointer-events-none"><Baby size={80} className="text-slate-800" /></div>
                <h2 className="text-xs font-bold text-slate-400 uppercase mb-4 flex items-center gap-2"><span className="bg-indigo-100 text-indigo-600 p-1 rounded-md"><Baby size={14} /></span> Hồ sơ trẻ</h2>
                <div className="space-y-4 relative z-10">
                    <DateSelect label="Ngày sinh" value={dob} onChange={setDob} />
                    <div>
                        <label className="block text-[11px] font-bold text-slate-500 mb-1.5 uppercase tracking-wider">Giới tính</label>
                        <div className="flex bg-slate-100/80 p-1.5 rounded-xl gap-2">
                            <button onClick={() => setGender('boy')} className={`flex-1 text-sm py-2.5 rounded-lg font-bold flex items-center justify-center gap-2 transition-all ${gender === 'boy' ? 'bg-white text-blue-600 shadow-md ring-1 ring-blue-100' : 'text-slate-400'}`}>{gender === 'boy' && <CheckCircle size={14} />} Nam</button>
                            <button onClick={() => setGender('girl')} className={`flex-1 text-sm py-2.5 rounded-lg font-bold flex items-center justify-center gap-2 transition-all ${gender === 'girl' ? 'bg-white text-pink-600 shadow-md ring-1 ring-pink-100' : 'text-slate-400'}`}>{gender === 'girl' && <CheckCircle size={14} />} Nữ</button>
                        </div>
                    </div>
                </div>
            </div>
        );

        // ==========================================
        // 5. MAIN APP COMPONENT
        // ==========================================
        
        const App = () => {
            const [activeTab, setActiveTab] = useState('home');
            const [records, setRecords] = useState([]);
            const [dob, setDob] = useState('2023-01-01');
            const [gender, setGender] = useState('boy');
            const [formData, setFormData] = useState({ date: new Date().toISOString().split('T')[0], weight: '', height: '' });
            const [loadingAdvice, setLoadingAdvice] = useState(false);
            const [aiAdvice, setAiAdvice] = useState('');
            const [mobileChartType, setMobileChartType] = useState('weight');

            const handleAddRecord = () => {
                if (!formData.weight || !formData.height) return;
                const age = calculateAgeMonths(dob, formData.date);
                const newRecord = {
                    id: Date.now().toString(),
                    date: formData.date,
                    ageMonths: age < 0 ? 0 : age,
                    weight: parseFloat(formData.weight),
                    height: parseFloat(formData.height)
                };
                setRecords(prev => [...prev, newRecord].sort((a,b) => a.ageMonths - b.ageMonths));
                setFormData(prev => ({ ...prev, weight: '', height: '' }));
                setAiAdvice('');
            };

            const handleDelete = (id) => setRecords(prev => prev.filter(r => r.id !== id));
            
            // FAKE SHARE APK Logic
            const handleShare = async () => {
                const htmlContent = document.documentElement.outerHTML;
                const blob = new Blob([htmlContent], { type: 'text/html' });
                // We name it .apk to simulate the file type, though it's technically HTML wrapper
                const file = new File([blob], "WHO_Growth_Tracker.apk", { type: 'application/vnd.android.package-archive' });
                if (navigator.share && navigator.canShare({ files: [file] })) {
                    try {
                        await navigator.share({ files: [file], title: 'WHO Growth App', text: 'Cài đặt App theo dõi sức khỏe cho bé ngay!' });
                    } catch (err) { console.log(err); }
                } else {
                    alert("Trình duyệt không hỗ trợ chia sẻ APK giả lập này.");
                }
            };

            const isPreviewMode = formData.weight !== '' || formData.height !== '';
            
            const currentData = useMemo(() => {
                if (isPreviewMode) {
                    const age = calculateAgeMonths(dob, formData.date);
                    const w = parseFloat(formData.weight);
                    const h = parseFloat(formData.height);
                    return { ageMonths: age < 0 ? 0 : age, weight: isNaN(w) ? 0 : w, height: isNaN(h) ? 0 : h, isPreview: true };
                } else if (records.length > 0) {
                    return { ...records[records.length - 1], isPreview: false };
                }
                return null;
            }, [formData, dob, records, isPreviewMode]);

            const wAnalysis = currentData && currentData.weight > 0 ? analyzeGrowth(currentData.ageMonths, currentData.weight, gender, 'weight') : null;
            const hAnalysis = currentData && currentData.height > 0 ? analyzeGrowth(currentData.ageMonths, currentData.height, gender, 'height') : null;

            const generateAdvice = async () => {
                if (!currentData || !wAnalysis || !hAnalysis) return;
                setLoadingAdvice(true);
                const advice = await getGeminiAdvice(currentData.ageMonths, gender, currentData.weight, currentData.height, wAnalysis, hAnalysis);
                setAiAdvice(advice);
                setLoadingAdvice(false);
            };

            const renderInputSection = () => (
                <div className="bg-white/80 backdrop-blur-md p-5 rounded-2xl border border-white/50 shadow-lg shadow-slate-200/50 mb-6 relative">
                    <div className="flex justify-between items-center mb-4">
                        <h2 className="text-xs font-bold text-slate-400 uppercase flex items-center gap-2"><span className="bg-teal-100 text-teal-600 p-1 rounded-md"><Stethoscope size={14} /></span> Nhập số đo</h2>
                        {isPreviewMode && <span className="flex items-center gap-1.5 text-[10px] text-teal-600 font-bold bg-teal-50 px-3 py-1 rounded-full border border-teal-100 animate-pulse"><span className="w-1.5 h-1.5 rounded-full bg-teal-500"></span>Dự tính...</span>}
                    </div>
                    <div className="space-y-6">
                        <DateSelect label="Ngày đo" value={formData.date} onChange={(val) => setFormData({...formData, date: val})} />
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <MetricInput label="Cân nặng" value={formData.weight} onChange={(val) => setFormData({...formData, weight: val})} unit="kg" min={0} max={40} analysis={wAnalysis} />
                            <MetricInput label="Chiều cao" value={formData.height} onChange={(val) => setFormData({...formData, height: val})} unit="cm" min={45} max={140} analysis={hAnalysis} />
                        </div>
                        <div className="flex gap-3 pt-2">
                            <button onClick={() => setFormData(prev => ({ ...prev, weight: '', height: '' }))} className="flex-none w-12 bg-slate-100 hover:bg-slate-200 text-slate-500 rounded-xl flex items-center justify-center active:scale-95"><RotateCcw size={20} /></button>
                            <button onClick={handleAddRecord} disabled={!formData.weight || !formData.height} className="flex-1 bg-gradient-to-r from-slate-800 to-slate-900 text-white py-4 rounded-xl text-sm font-bold flex items-center justify-center gap-2 shadow-xl shadow-slate-200 disabled:opacity-50"><Save size={18} /> Lưu kết quả</button>
                        </div>
                    </div>
                </div>
            );

            const renderAnalysisSection = () => (
                <div className="space-y-4 mb-20 md:mb-0">
                    {(wAnalysis || hAnalysis) ? (
                        <div className="grid grid-cols-1 gap-4">
                            <div className="flex items-center justify-between px-1"><div className="text-sm font-bold text-slate-700 flex items-center gap-2"><div className={`w-2.5 h-2.5 rounded-full ring-2 ring-white shadow-sm ${currentData?.isPreview ? 'bg-teal-500 animate-pulse' : 'bg-slate-400'}`}></div>{currentData?.isPreview ? 'Phân tích trực tiếp...' : `Kết quả (${currentData?.ageMonths} tháng)`}</div></div>
                            {wAnalysis && <div className={`p-5 rounded-2xl border shadow-sm ${wAnalysis.status === 'normal' ? 'bg-green-50/50 border-green-100' : 'bg-orange-50/50 border-orange-100'}`}><div className="flex justify-between items-start mb-3"><span className="text-xs font-bold text-slate-500 uppercase">Cân nặng</span></div><div className="flex items-baseline gap-1.5 mb-2"><span className="text-3xl font-black text-slate-800">{currentData.weight}</span><span className="text-sm font-bold text-slate-400">kg</span></div><ZScoreGauge zScore={wAnalysis.zScore} label={wAnalysis.message} /></div>}
                            {hAnalysis && <div className={`p-5 rounded-2xl border shadow-sm ${hAnalysis.status === 'normal' ? 'bg-green-50/50 border-green-100' : 'bg-orange-50/50 border-orange-100'}`}><div className="flex justify-between items-start mb-3"><span className="text-xs font-bold text-slate-500 uppercase">Chiều cao</span></div><div className="flex items-baseline gap-1.5 mb-2"><span className="text-3xl font-black text-slate-800">{currentData.height}</span><span className="text-sm font-bold text-slate-400">cm</span></div><ZScoreGauge zScore={hAnalysis.zScore} label={hAnalysis.message} /></div>}
                            {!aiAdvice ? <button onClick={generateAdvice} disabled={loadingAdvice} className="w-full bg-gradient-to-r from-indigo-600 to-purple-600 text-white py-4 rounded-2xl text-sm font-bold shadow-lg flex justify-center items-center gap-2 mt-2">{loadingAdvice ? 'Đang kết nối...' : <><Activity size={18}/> Xin lời khuyên AI</>}</button> : <div className="bg-white p-6 rounded-2xl border border-indigo-100 mt-2 text-sm text-slate-700 shadow-lg"><div className="flex items-center gap-2 mb-4 font-bold text-indigo-700 pb-3 border-b border-indigo-50"><Activity size={18}/> Lời khuyên chuyên gia</div>{aiAdvice}<button onClick={() => setAiAdvice('')} className="block mt-6 text-xs text-indigo-600 bg-indigo-50 py-2.5 px-5 rounded-xl font-bold ml-auto">Đóng</button></div>}
                        </div>
                    ) : (
                         <div className="text-center py-16 bg-white/50 backdrop-blur-sm rounded-3xl border border-dashed border-slate-300"><div className="w-16 h-16 bg-white rounded-2xl shadow-sm border border-slate-100 flex items-center justify-center mx-auto mb-4"><Stethoscope size={32} className="text-slate-300"/></div><p className="text-sm text-slate-500 font-medium">Nhập số liệu để xem kết quả</p></div>
                    )}
                </div>
            );

            return (
                <div className="flex flex-col h-full bg-slate-50">
                    <div className="bg-white/90 backdrop-blur-md px-5 py-4 border-b border-slate-200 sticky top-0 z-30 flex justify-between items-center shadow-sm">
                        <div className="flex items-center gap-3"><div className="bg-teal-600 p-2 rounded-xl text-white shadow-lg"><Activity size={20} /></div><h1 className="font-black text-lg text-slate-800">WHO Growth</h1></div>
                        <button onClick={handleShare} className="p-2.5 text-slate-400 hover:bg-slate-100 rounded-full active:scale-90 transition-all"><Share2 size={20}/></button>
                    </div>

                    <div className="flex-1 overflow-y-auto p-4 pb-28 scroll-smooth">
                        {activeTab === 'home' && (
                            <div className="animate-in fade-in slide-in-from-bottom-2 duration-300">
                                <ChildInfoSection dob={dob} setDob={setDob} gender={gender} setGender={setGender} />
                                {renderInputSection()}
                                {renderAnalysisSection()}
                            </div>
                        )}
                        {activeTab === 'charts' && (
                            <div className="animate-in fade-in slide-in-from-bottom-2 duration-300 space-y-4">
                                <div className="flex bg-white rounded-2xl p-1.5 shadow-sm border border-slate-200 mb-2 sticky top-2 z-20 mx-1">
                                    <button onClick={() => setMobileChartType('weight')} className={`flex-1 py-3 text-sm font-bold rounded-xl transition-all ${mobileChartType === 'weight' ? 'bg-teal-50 text-teal-700 shadow-sm ring-1 ring-teal-100' : 'text-slate-400'}`}>Cân nặng</button>
                                    <button onClick={() => setMobileChartType('height')} className={`flex-1 py-3 text-sm font-bold rounded-xl transition-all ${mobileChartType === 'height' ? 'bg-teal-50 text-teal-700 shadow-sm ring-1 ring-teal-100' : 'text-slate-400'}`}>Chiều cao</button>
                                </div>
                                <div className="bg-white rounded-3xl p-1 shadow-sm border border-slate-100 overflow-hidden">
                                    {(records.length > 0 || isPreviewMode) ? (
                                        <div className="h-[auto] min-h-[60vh]">
                                            <GrowthChart records={records} gender={gender} type={mobileChartType} previewData={isPreviewMode ? currentData : null} />
                                            <div className="px-4 pb-4"><ChartGuide /></div>
                                        </div>
                                    ) : <div className="text-center py-20 text-slate-400"><BarChart2 size={48} className="mx-auto mb-3 opacity-20"/><p>Chưa có dữ liệu.</p></div>}
                                </div>
                            </div>
                        )}
                        {activeTab === 'history' && (
                            <div className="animate-in fade-in slide-in-from-bottom-2 duration-300 space-y-3">
                                <div className="flex justify-between items-end mb-4 px-2"><h2 className="text-base font-bold text-slate-700">Lịch sử ({records.length})</h2></div>
                                {records.length === 0 ? <div className="text-center text-slate-400 py-16 text-sm bg-white rounded-3xl border border-dashed border-slate-200">Chưa có bản ghi nào.</div> : records.slice().reverse().map(r => (
                                    <div key={r.id} className="bg-white p-5 rounded-2xl border border-slate-100 shadow-sm flex justify-between items-center">
                                        <div>
                                            <div className="flex items-center gap-3 mb-2"><span className="font-bold text-slate-800 text-lg">{new Date(r.date).toLocaleDateString('vi-VN')}</span><span className="bg-slate-100 text-slate-500 text-[10px] px-2.5 py-1 rounded-full font-bold uppercase tracking-wide border border-slate-200">{r.ageMonths} tháng</span></div>
                                            <div className="text-sm text-slate-600 font-medium flex items-center gap-4"><span>{r.weight} kg</span><span>{r.height} cm</span></div>
                                        </div>
                                        <button onClick={() => handleDelete(r.id)} className="p-3 text-slate-300 hover:text-red-500 rounded-full"><Trash2 size={20} /></button>
                                    </div>
                                ))}
                            </div>
                        )}
                    </div>

                    <div className="fixed bottom-0 left-0 right-0 bg-white/90 backdrop-blur-lg border-t border-slate-200/60 px-6 py-2 flex justify-between items-center z-30 pb-safe shadow-[0_-10px_20px_rgba(0,0,0,0.03)]">
                        <button onClick={() => setActiveTab('home')} className={`flex flex-col items-center gap-1 p-2 rounded-2xl transition-all ${activeTab === 'home' ? 'text-teal-600 bg-teal-50 -translate-y-1' : 'text-slate-400'}`}><Home size={24} strokeWidth={activeTab === 'home' ? 3 : 2} /><span className="text-[10px] font-bold">Nhập liệu</span></button>
                        <button onClick={() => setActiveTab('charts')} className={`flex flex-col items-center gap-1 p-2 rounded-2xl transition-all ${activeTab === 'charts' ? 'text-teal-600 bg-teal-50 -translate-y-1' : 'text-slate-400'}`}><BarChart2 size={24} strokeWidth={activeTab === 'charts' ? 3 : 2} /><span className="text-[10px] font-bold">Biểu đồ</span></button>
                        <button onClick={() => setActiveTab('history')} className={`flex flex-col items-center gap-1 p-2 rounded-2xl transition-all ${activeTab === 'history' ? 'text-teal-600 bg-teal-50 -translate-y-1' : 'text-slate-400'}`}><History size={24} strokeWidth={activeTab === 'history' ? 3 : 2} /><span className="text-[10px] font-bold">Lịch sử</span></button>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>

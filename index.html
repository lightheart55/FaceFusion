
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/vite.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>AI Face Fusion</title>
    
    <!-- 1. Global Error Handler: Displays errors on screen instead of white screen -->
    <script>
      window.onerror = function(msg, url, line, col, error) {
        document.body.innerHTML = `
          <div style="background: #111; color: #ff5555; font-family: monospace; padding: 20px; height: 100vh; overflow: auto;">
            <h3 style="border-bottom: 1px solid #333; padding-bottom: 10px;">Application Error</h3>
            <p><strong>Message:</strong> ${msg}</p>
            <p><strong>Location:</strong> ${url}:${line}:${col}</p>
            <pre style="background: #222; padding: 10px; border-radius: 5px; overflow-x: auto;">${error ? error.stack : 'No stack trace'}</pre>
            <p style="color: #888; margin-top: 20px;">If you see this on Vercel, check your API_KEY configuration or Import Map compatibility.</p>
          </div>
        `;
      };

      // Polyfill process.env safely
      window.process = window.process || { env: { API_KEY: '' } };
    </script>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
      body {
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
        touch-action: manipulation;
      }
    </style>

    <!-- 2. Fixed Import Map: Use consistent React 18 versions via esm.sh to avoid dependency hell -->
    <script type="importmap">
{
  "imports": {
    "@google/genai": "https://esm.sh/@google/genai@0.1.1",
    "react": "https://esm.sh/react@18.2.0",
    "react-dom/client": "https://esm.sh/react-dom@18.2.0/client?deps=react@18.2.0",
    "react-dom/": "https://esm.sh/react-dom@^19.2.3/",
    "react/": "https://esm.sh/react@^19.2.3/"
  }
}
</script>

    <script>
      // Dynamic PWA Manifest Generation
      try {
        const manifest = {
          "name": "AI Face Fusion",
          "short_name": "FaceFusion",
          "start_url": ".",
          "display": "standalone",
          "background_color": "#111827",
          "theme_color": "#111827",
          "orientation": "portrait",
          "scope": ".",
          "icons": [
            {
              "src": "https://cdn-icons-png.flaticon.com/512/11698/11698436.png",
              "sizes": "192x192",
              "type": "image/png"
            }
          ]
        };
        const manifestBlob = new Blob([JSON.stringify(manifest)], {type: 'application/manifest+json'});
        const manifestUrl = URL.createObjectURL(manifestBlob);
        const link = document.createElement('link');
        link.rel = 'manifest';
        link.href = manifestUrl;
        document.head.appendChild(link);
      } catch (e) {
        console.warn("PWA Manifest creation failed", e);
      }
    </script>
  </head>
  <body class="bg-gray-900 select-none text-white">
    <div id="root"></div>

    <script type="text/babel" data-type="module" data-presets="react,typescript">
      import React, { useState, useCallback, useRef } from 'react';
      import ReactDOM from 'react-dom/client';
      import { GoogleGenAI, Modality } from "@google/genai";

      // ==========================================
      // UTILS
      // ==========================================
      const fileToBase64 = (file: File): Promise<string> => {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.readAsDataURL(file);
          reader.onload = () => resolve(reader.result as string);
          reader.onerror = (error) => reject(error);
        });
      };

      const getBase64Data = (dataUri: string): { mimeType: string; data: string } => {
        const parts = dataUri.split(',');
        if (parts.length !== 2) {
          throw new Error('Invalid data URI');
        }
        const mimeType = parts[0].split(':')[1].split(';')[0];
        const data = parts[1];
        return { mimeType, data };
      };

      // ==========================================
      // SERVICES
      // ==========================================
      
      const generateSwappedImage = async (
        originalImageBase64: string,
        templateImageBase64: string
      ): Promise<string> => {
        try {
          const API_KEY = process.env.API_KEY;
          if (!API_KEY) {
            // Provide a clearer error message for Vercel users
            throw new Error("API Key không tìm thấy. Nếu bạn đang chạy trên Vercel, hãy đảm bảo bạn đã cấu hình Environment Variables hoặc chỉnh sửa code để thêm key.");
          }
          
          const ai = new GoogleGenAI({ apiKey: API_KEY });
          
          const originalImage = getBase64Data(originalImageBase64);
          const templateImage = getBase64Data(templateImageBase64);

          // PROMPT LOGIC: STRICT BODY REPLACEMENT
          const prompt = `**YÊU CẦU NHIỆM VỤ: FACE SWAP - GIỮ MẶT, THAY BODY**

**ĐẦU VÀO:**
*   **HÌNH 1 (Nguồn Mặt):** Lấy khuôn mặt từ ảnh này.
*   **HÌNH 2 (Nguồn Body):** Lấy toàn bộ cơ thể, trang phục, tóc tai và bối cảnh từ ảnh này.

**THỰC HIỆN:**
1.  **CẮT GHÉP:** Thay thế khuôn mặt của người trong HÌNH 2 bằng khuôn mặt của người trong HÌNH 1.
2.  **BẢO TOÀN DANH TÍNH:** Khuôn mặt mới phải giữ nguyên 100% đặc điểm nhận dạng (mắt, mũi, miệng) của HÌNH 1.
3.  **BẢO TOÀN BỐI CẢNH:** Tuyệt đối KHÔNG thay đổi tư thế, quần áo, hình dáng cơ thể hay hậu cảnh của HÌNH 2.
4.  **HÒA TRỘN:** Điều chỉnh màu da (skin tone) và ánh sáng của khuôn mặt (HÌNH 1) để khớp hoàn hảo với cơ thể (HÌNH 2).

**KẾT QUẢ:** Ảnh hoàn thiện trông tự nhiên như thể người trong HÌNH 1 đang mặc đồ và đứng trong bối cảnh của HÌNH 2.`;

          const response = await ai.models.generateContent({
            model: 'gemini-2.5-flash-image',
            contents: {
              parts: [
                {
                  inlineData: {
                    mimeType: originalImage.mimeType,
                    data: originalImage.data,
                  },
                },
                {
                  inlineData: {
                      mimeType: templateImage.mimeType,
                      data: templateImage.data,
                  }
                },
                { text: prompt },
              ],
            },
            config: {
              responseModalities: [Modality.IMAGE],
            },
          });

          for (const part of response.candidates?.[0]?.content?.parts || []) {
            if (part.inlineData) {
              const base64ImageBytes: string = part.inlineData.data;
              const mimeType = part.inlineData.mimeType;
              return `data:${mimeType};base64,${base64ImageBytes}`;
            }
          }
          
          throw new Error('Không nhận được hình ảnh từ API. Vui lòng thử lại.');

        } catch (error) {
          console.error("Error calling Gemini API:", error);
          if (error instanceof Error) {
             throw error;
          }
          throw new Error('Đã xảy ra lỗi không xác định khi gọi AI.');
        }
      };

      // ==========================================
      // ICONS
      // ==========================================
      const UploadIcon = (props) => (
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" {...props}>
              <path strokeLinecap="round" strokeLinejoin="round" d="M3 16.5v2.25A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75V16.5m-13.5-9L12 3m0 0 4.5 4.5M12 3v13.5" />
          </svg>
      );

      const LoadingSpinnerIcon = (props) => (
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="animate-spin" {...props}>
          <path d="M21 12a9 9 0 1 1-6.219-8.56" />
        </svg>
      );

      const WandIcon = (props) => (
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" {...props}>
              <path strokeLinecap="round" strokeLinejoin="round" d="M9.53 16.122a3 3 0 0 0-5.78 1.128 2.25 2.25 0 0 1-2.475 2.118A2.25 2.25 0 0 1 .75 15.75V14.25m18 0V15.75a2.25 2.25 0 0 1-2.25 2.25A2.25 2.25 0 0 1 13.5 15.75V14.25m-6 0V9.75M9.75 9.75h4.5m-4.5 0a3.75 3.75 0 0 1-3.75-3.75V4.5a3.75 3.75 0 0 1 3.75-3.75h4.5A3.75 3.75 0 0 1 18 4.5v1.5a3.75 3.75 0 0 1-3.75 3.75M6.75 9.75h4.5" />
          </svg>
      );

      const DownloadIcon = (props) => (
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" {...props}>
              <path strokeLinecap="round" strokeLinejoin="round" d="M3 16.5v2.25A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75V16.5M16.5 12 12 16.5m0 0L7.5 12m4.5 4.5V3" />
          </svg>
      );

      const SparklesIcon = (props) => (
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" {...props}>
              <path strokeLinecap="round" strokeLinejoin="round" d="M9.813 15.904 9 18.75l-.813-2.846a4.5 4.5 0 0 0-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 0 0 3.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 0 0 3.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 0 0-3.09 3.09ZM18.259 8.715 18 9.75l-.259-1.035a3.375 3.375 0 0 0-2.455-2.456L14.25 6l1.036-.259a3.375 3.375 0 0 0 2.455-2.456L18 2.25l.259 1.035a3.375 3.375 0 0 0 2.456 2.456L21.75 6l-1.035.259a3.375 3.375 0 0 0-2.456 2.456Z" />
          </svg>
      );

      const ShareIcon = (props) => (
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" {...props}>
              <path strokeLinecap="round" strokeLinejoin="round" d="M7.217 10.907a2.25 2.25 0 1 0 0 2.186m0-2.186c.18.324.283.696.283 1.093s-.103.77-.283 1.093m0-2.186 9.566-5.314m-9.566 7.5 9.566 5.314m0 0a2.25 2.25 0 1 0 3.935 2.186 2.25 2.25 0 0 0-3.935-2.186Zm0-12.814a2.25 2.25 0 1 0 3.933-2.185 2.25 2.25 0 0 0-3.933 2.185Z" />
          </svg>
      );

      // ==========================================
      // COMPONENTS
      // ==========================================
      
      const Header = () => {
          const handleShare = () => {
              // Create a standalone HTML file from the current document
              const htmlContent = document.documentElement.outerHTML;
              const blob = new Blob([htmlContent], { type: 'text/html' });
              const url = URL.createObjectURL(blob);
              const a = document.createElement('a');
              a.href = url;
              a.download = 'AI-Face-Fusion.html';
              document.body.appendChild(a);
              a.click();
              document.body.removeChild(a);
              URL.revokeObjectURL(url);
          };

          return (
              <header className="text-center relative">
                  <div className="absolute top-0 right-0">
                      <button 
                          onClick={handleShare}
                          className="flex items-center gap-2 px-3 py-1.5 text-sm font-medium text-indigo-300 bg-white/5 rounded-lg hover:bg-white/10 transition-colors border border-white/10"
                          title="Tải về phiên bản Offline (Single File)"
                      >
                          <ShareIcon className="w-4 h-4" />
                          <span className="hidden sm:inline">Tải App</span>
                      </button>
                  </div>
                  <div className="inline-flex items-center justify-center gap-3">
                      <SparklesIcon className="w-10 h-10 text-indigo-400"/>
                      <h1 className="text-4xl sm:text-5xl font-bold tracking-tight bg-gradient-to-r from-purple-400 via-indigo-400 to-blue-500 text-transparent bg-clip-text">
                          AI Face Fusion
                      </h1>
                  </div>
                  <p className="mt-6 text-lg leading-8 text-gray-300">
                  Giữ lại gương mặt bạn, thay đổi mọi thứ còn lại. Tải lên ảnh gốc và ảnh mẫu để tạo ra một tác phẩm hoàn toàn mới.
                  </p>
              </header>
          )
      }

      const ImageUploader = ({ id, title, onImageUpload, imagePreviewUrl }) => {
        const inputRef = useRef(null);

        const handleFileChange = (event) => {
          const file = event.target.files?.[0];
          if (file) {
            onImageUpload(file);
          }
        };

        const handleClick = () => {
          inputRef.current?.click();
        };

        return (
          <div className="flex flex-col items-center">
            <h2 className="text-xl font-semibold text-gray-200 mb-4">{title}</h2>
            <div 
              onClick={handleClick}
              className="relative group w-full aspect-square max-w-md bg-white/5 rounded-xl border-2 border-dashed border-gray-600 hover:border-indigo-500 transition-all duration-300 cursor-pointer flex justify-center items-center overflow-hidden"
            >
              <input
                ref={inputRef}
                id={id}
                type="file"
                accept="image/png, image/jpeg, image/webp"
                className="hidden"
                onChange={handleFileChange}
              />
              {imagePreviewUrl ? (
                <>
                  <img src={imagePreviewUrl} alt="Preview" className="w-full h-full object-cover" />
                  <div className="absolute inset-0 bg-black/50 opacity-0 group-hover:opacity-100 transition-opacity duration-300 flex justify-center items-center">
                      <p className="text-white text-lg">Thay đổi ảnh</p>
                  </div>
                </>
              ) : (
                <div className="text-center text-gray-400 p-4">
                  <UploadIcon className="w-12 h-12 mx-auto mb-2" />
                  <p className="font-semibold">Nhấp để tải ảnh lên</p>
                  <p className="text-sm">PNG, JPG, WEBP</p>
                </div>
              )}
            </div>
          </div>
        );
      };

      const GenerateButton = ({ onClick, isLoading, disabled }) => {
          return (
              <button
                  onClick={onClick}
                  disabled={isLoading || disabled}
                  className="inline-flex items-center justify-center gap-2 px-8 py-4 text-lg font-semibold text-white bg-indigo-600 rounded-full shadow-lg hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 focus:ring-offset-gray-900 transition-all duration-300 disabled:bg-indigo-900/50 disabled:cursor-not-allowed transform hover:scale-105 disabled:scale-100"
              >
                  {isLoading ? (
                      <>
                          <LoadingSpinnerIcon className="w-6 h-6" />
                          Đang xử lý...
                      </>
                  ) : (
                      <>
                          <WandIcon className="w-6 h-6" />
                          Tạo ảnh
                      </>
                  )}
              </button>
          )
      }

      const ResultDisplay = ({ isLoading, resultImage }) => {
          if (isLoading) {
              return (
                  <div className="mt-12">
                      <h2 className="text-2xl font-bold text-center mb-6">Kết quả</h2>
                      <div className="w-full aspect-video bg-white/5 rounded-xl border-2 border-dashed border-gray-600 flex flex-col justify-center items-center text-gray-400">
                          <LoadingSpinnerIcon className="w-12 h-12 mb-4"/>
                          <p className="text-lg font-semibold">AI đang sáng tạo...</p>
                          <p className="text-sm mt-2 max-w-md text-center">Đang phân tích khuôn mặt và ghép vào cơ thể mới. Vui lòng chờ giây lát.</p>
                      </div>
                  </div>
              )
          }

          if (!resultImage) {
              return null;
          }

          return (
              <div className="mt-12">
                  <h2 className="text-2xl font-bold text-center mb-6">Kết quả của bạn</h2>
                  <div className="w-full max-w-2xl mx-auto">
                      <div className="relative group">
                          <img src={resultImage} alt="Generated result" className="rounded-xl shadow-2xl shadow-indigo-500/20 w-full" />
                          <a
                              href={resultImage}
                              download="ai-face-fusion-result.png"
                              className="absolute bottom-4 right-4 flex items-center gap-2 bg-black/50 text-white px-4 py-2 rounded-lg opacity-0 group-hover:opacity-100 transition-opacity duration-300 hover:bg-black/80"
                          >
                              <DownloadIcon className="w-5 h-5" />
                              Tải xuống
                          </a>
                      </div>
                  </div>
              </div>
          )
      }

      // ==========================================
      // MAIN APP
      // ==========================================
      
      const App = () => {
        const [originalImage, setOriginalImage] = useState(null);
        const [templateImage, setTemplateImage] = useState(null);
        const [resultImage, setResultImage] = useState(null);
        const [isLoading, setIsLoading] = useState(false);
        const [error, setError] = useState(null);

        const handleImageUpload = async (file, type) => {
          try {
            const base64 = await fileToBase64(file);
            if (type === 'original') {
              setOriginalImage(base64);
            } else {
              setTemplateImage(base64);
            }
            setResultImage(null);
            setError(null);
          } catch (err) {
            setError('Không thể tải ảnh lên. Vui lòng thử lại.');
          }
        };

        const handleGenerate = useCallback(async () => {
          if (!originalImage || !templateImage) {
            setError('Vui lòng tải lên cả hai ảnh gốc và ảnh mẫu.');
            return;
          }
          setIsLoading(true);
          setResultImage(null);
          setError(null);
          try {
            const generatedImage = await generateSwappedImage(originalImage, templateImage);
            setResultImage(generatedImage);
          } catch (err) {
            const errorMessage = err instanceof Error ? err.message : 'Đã xảy ra lỗi không mong muốn.';
            setError(`Lỗi: ${errorMessage}`);
          } finally {
            setIsLoading(false);
          }
        }, [originalImage, templateImage]);

        return (
          <div className="min-h-screen bg-gray-900 text-white font-sans">
            <div className="relative isolate px-6 pt-14 lg:px-8">
              <div className="absolute inset-x-0 -top-40 -z-10 transform-gpu overflow-hidden blur-3xl sm:-top-80" aria-hidden="true">
                <div className="relative left-[calc(50%-11rem)] aspect-[1155/678] w-[36.125rem] -translate-x-1/2 rotate-[30deg] bg-gradient-to-tr from-[#ff80b5] to-[#9089fc] opacity-30 sm:left-[calc(50%-30rem)] sm:w-[72.1875rem]" style={{ clipPath: 'polygon(74.1% 44.1%, 100% 61.6%, 97.5% 26.9%, 85.5% 0.1%, 80.7% 2%, 72.5% 32.5%, 60.2% 62.4%, 52.4% 68.1%, 47.5% 58.3%, 45.2% 34.5%, 27.5% 76.7%, 0.1% 64.9%, 17.9% 100%, 27.6% 76.8%, 76.1% 97.7%, 74.1% 44.1%)' }}></div>
              </div>

              <main className="container mx-auto px-4 py-8">
                <Header />
                
                <div className="grid grid-cols-1 md:grid-cols-2 gap-8 mt-12">
                  <ImageUploader 
                    id="original-image"
                    title="Ảnh Gốc (Gương mặt)"
                    onImageUpload={(file) => handleImageUpload(file, 'original')}
                    imagePreviewUrl={originalImage}
                  />
                  <ImageUploader 
                    id="template-image"
                    title="Ảnh Mẫu (Bối cảnh)"
                    onImageUpload={(file) => handleImageUpload(file, 'template')}
                    imagePreviewUrl={templateImage}
                  />
                </div>

                <div className="mt-12 text-center">
                  <GenerateButton 
                    onClick={handleGenerate}
                    isLoading={isLoading}
                    disabled={!originalImage || !templateImage}
                  />
                </div>

                {error && <p className="mt-8 text-center text-red-400 bg-red-900/20 p-3 rounded-md">{error}</p>}
                
                <ResultDisplay isLoading={isLoading} resultImage={resultImage} />

              </main>

              <div className="absolute inset-x-0 top-[calc(100%-13rem)] -z-10 transform-gpu overflow-hidden blur-3xl sm:top-[calc(100%-30rem)]" aria-hidden="true">
                <div className="relative left-[calc(50%+3rem)] aspect-[1155/678] w-[36.125rem] -translate-x-1/2 bg-gradient-to-tr from-[#ff80b5] to-[#9089fc] opacity-30 sm:left-[calc(50%+36rem)] sm:w-[72.1875rem]" style={{ clipPath: 'polygon(74.1% 44.1%, 100% 61.6%, 97.5% 26.9%, 85.5% 0.1%, 80.7% 2%, 72.5% 32.5%, 60.2% 62.4%, 52.4% 68.1%, 47.5% 58.3%, 45.2% 34.5%, 27.5% 76.7%, 0.1% 64.9%, 17.9% 100%, 27.6% 76.8%, 76.1% 97.7%, 74.1% 44.1%)' }}></div>
              </div>
            </div>
          </div>
        );
      };

      const rootElement = document.getElementById('root');
      if (!rootElement) {
        throw new Error("Could not find root element to mount to");
      }

      const root = ReactDOM.createRoot(rootElement);
      root.render(
        <React.StrictMode>
          <App />
        </React.StrictMode>
      );
    </script>
  </body>
</html>
